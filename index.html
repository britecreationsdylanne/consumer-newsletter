<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BriteCo Consumer Newsletter Generator</title>
    <script
      src="https://britepulse-api-29820647719.us-central1.run.app/sdk.js"
      data-api-key="pk_cac144b3-63d8-460d-8c04-7370a9c34351_9ac79683be9b4fa3b699eb9881597af0"
      data-api-url="https://britepulse-api-29820647719.us-central1.run.app"
      defer
    ></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #018181 0%, #272d3f 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: visible;
        }
        .header {
            background: #272d3f;
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }
        .header h1 { font-size: 32px; font-weight: 700; }
        .header .subtitle { font-size: 14px; color: rgba(255,255,255,0.6); margin-top: 4px; }
        .start-over-btn {
            background: #FE8916; color: white; border: none;
            padding: 8px 18px; border-radius: 6px; font-size: 13px;
            font-weight: 600; cursor: pointer; transition: background 0.2s;
        }
        .start-over-btn:hover { background: #e57a0e; }
        .header-right {
            position: absolute; top: 16px; right: 20px;
            display: flex; align-items: center; gap: 12px;
        }
        .user-profile {
            position: relative;
        }
        .user-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; border: 2px solid rgba(255,255,255,0.3);
            transition: border-color 0.2s;
            object-fit: cover;
        }
        .user-avatar:hover { border-color: rgba(255,255,255,0.6); }
        .user-dropdown {
            position: absolute; top: 50px; right: 0;
            background: white; border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 200px; padding: 16px;
            display: none; z-index: 1000;
        }
        .user-dropdown.active { display: block; }
        .user-dropdown-name {
            font-weight: 600; color: #1f2937; font-size: 15px;
            margin-bottom: 2px;
        }
        .user-dropdown-email {
            color: #018181; font-size: 13px; margin-bottom: 12px;
        }
        .user-dropdown-divider {
            height: 1px; background: #e5e7eb; margin: 12px 0;
        }
        .user-dropdown-signout {
            color: #6b7280; font-size: 14px; cursor: pointer;
            transition: color 0.2s; text-decoration: none; display: block;
        }
        .user-dropdown-signout:hover { color: #1f2937; }
        .progress-container { margin: 0 40px 20px 40px; }
        .progress-text {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; font-size: 14px; color: #4b5563;
        }
        .progress-step-text { font-weight: 600; color: #018181; }
        .progress-label { color: #6b7280; }
        .progress { background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-bar {
            background: #018181; height: 100%; width: 0%;
            transition: width 0.3s ease; border-radius: 4px;
        }
        .step { padding: 40px; display: none; }
        .step.active { display: block; }
        .step h2 { color: #272d3f; font-size: 28px; margin-bottom: 10px; }
        .step > p.step-description { color: #666; margin-bottom: 30px; }

        /* Month Grid */
        .month-grid {
            display: flex; flex-direction: column; gap: 10px;
            margin: 30px auto; max-width: 400px; min-height: 600px;
        }
        .month-card {
            background: white; border: 2px solid #e5e7eb; border-radius: 8px;
            padding: 15px 20px; text-align: left; cursor: pointer;
            transition: all 0.2s; display: flex; justify-content: space-between; align-items: center;
        }
        .month-card:hover {
            border-color: #018181; transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(1,129,129,0.15);
        }
        .month-card.selected { background: #018181; border-color: #018181; color: white; }
        .month-card .name { font-weight: 600; font-size: 16px; }
        .month-card .season { font-size: 13px; color: #999; text-transform: capitalize; }
        .month-card.selected .season { color: rgba(255,255,255,0.7); }

        /* Buttons */
        .btn {
            background: #018181; color: white; border: none;
            padding: 14px 32px; border-radius: 8px; font-size: 16px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .btn:hover { background: #016666; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(1,129,129,0.3); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-blue { background: #3b82f6; }
        .btn-blue:hover { background: #2563eb; }
        .btn-green { background: #059669; }
        .btn-green:hover { background: #047857; }
        .btn-orange { background: #FE8916; }
        .btn-orange:hover { background: #e57a0e; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-small {
            background: #018181; color: white; border: none;
            padding: 6px 14px; border-radius: 6px; font-size: 13px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .btn-small:hover { background: #016666; }
        .btn-small:disabled { background: #ccc; cursor: not-allowed; }
        .buttons { display: flex; gap: 10px; margin-top: 30px; flex-wrap: wrap; }

        /* Loading */
        .loading { text-align: center; padding: 60px 20px; }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #e5e7eb;
            border-top-color: #018181; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #272d3f; }
        .form-group textarea, .form-group input[type="text"], .form-group input[type="url"], .form-group select {
            width: 100%; padding: 12px; border: 2px solid #e5e7eb;
            border-radius: 8px; font-size: 14px; font-family: inherit;
        }
        .form-group textarea:focus, .form-group input:focus, .form-group select:focus {
            outline: none; border-color: #018181;
        }
        .textarea-actions {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 8px;
        }
        .word-count { font-size: 12px; color: #999; }

        /* Tabs */
        .tab-bar {
            display: flex; gap: 0; margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        .tab-btn {
            padding: 12px 24px; border: none; background: none;
            font-size: 14px; font-weight: 600; color: #6b7280;
            cursor: pointer; border-bottom: 3px solid transparent;
            margin-bottom: -2px; transition: all 0.2s;
        }
        .tab-btn:hover { color: #018181; }
        .tab-btn.active { color: #018181; border-bottom-color: #018181; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Sort bar */
        .sort-bar { display: flex; gap: 8px; margin-bottom: 20px; }
        .sort-btn {
            padding: 6px 16px; border: 2px solid #e5e7eb; border-radius: 20px;
            background: white; font-size: 13px; font-weight: 600;
            color: #6b7280; cursor: pointer; transition: all 0.2s;
        }
        .sort-btn:hover { border-color: #018181; color: #018181; }
        .sort-btn.active { background: #018181; color: white; border-color: #018181; }

        /* Selection slots */
        .selection-slots {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
            margin-bottom: 24px;
        }
        .selection-slot {
            border: 2px dashed #e5e7eb; border-radius: 12px;
            padding: 16px; min-height: 80px; transition: all 0.2s;
        }
        .selection-slot.filled { border-style: solid; border-color: #018181; background: #f0fafa; }
        .selection-slot .slot-label {
            font-size: 11px; text-transform: uppercase; font-weight: 700;
            color: #018181; letter-spacing: 0.5px; margin-bottom: 8px;
        }
        .selection-slot .slot-title { font-size: 14px; font-weight: 600; color: #272d3f; }
        .selection-slot .slot-meta { font-size: 12px; color: #999; margin-top: 4px; }
        .selection-slot .slot-clear {
            font-size: 11px; color: #dc3545; cursor: pointer;
            margin-top: 6px; display: inline-block;
        }
        .selection-slot .slot-clear:hover { text-decoration: underline; }
        .selection-slot .slot-empty { font-size: 13px; color: #999; font-style: italic; }

        /* Video Grid */
        .video-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .video-card {
            border: 2px solid #e5e7eb; border-radius: 12px;
            overflow: hidden; cursor: pointer; transition: all 0.2s;
        }
        .video-card:hover { border-color: #018181; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .video-card.selected { border-color: #018181; background: #f0fafa; box-shadow: 0 0 0 3px rgba(1,129,129,0.2); }
        .video-card .thumb {
            width: 100%; aspect-ratio: 16/9; object-fit: cover; display: block;
        }
        .video-card .video-info { padding: 12px; }
        .video-card .video-title {
            font-size: 14px; font-weight: 600; color: #272d3f;
            line-height: 1.4; margin-bottom: 6px;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .video-card .video-meta { font-size: 12px; color: #999; display: flex; gap: 12px; }
        .video-card .selected-badge {
            display: none; position: absolute; top: 8px; right: 8px;
            background: #018181; color: white; padding: 4px 10px;
            border-radius: 12px; font-size: 11px; font-weight: 700;
        }
        .video-card.selected .selected-badge { display: block; }
        .video-card { position: relative; }

        /* Blog Grid */
        .blog-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .blog-card {
            border: 2px solid #e5e7eb; border-radius: 12px;
            overflow: hidden; cursor: pointer; transition: all 0.2s;
        }
        .blog-card:hover { border-color: #018181; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .blog-card.selected { border-color: #018181; background: #f0fafa; box-shadow: 0 0 0 3px rgba(1,129,129,0.2); }
        .blog-card .blog-image {
            width: 100%; height: 180px; object-fit: cover; display: block;
        }
        .blog-card .blog-info { padding: 16px; }
        .blog-card .blog-title {
            font-size: 15px; font-weight: 600; color: #272d3f;
            line-height: 1.4; margin-bottom: 8px;
        }
        .blog-card .blog-excerpt {
            font-size: 13px; color: #666; line-height: 1.5;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .blog-card .blog-meta {
            font-size: 12px; color: #999; margin-top: 8px;
            display: flex; justify-content: space-between;
        }
        .blog-card .blog-categories { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
        .blog-card .blog-cat {
            font-size: 11px; background: #f0f0f0; color: #666;
            padding: 2px 8px; border-radius: 10px;
        }
        .blog-card.selected .blog-cat { background: #018181; color: white; }

        /* Blog selected banner */
        .selected-banner {
            background: #f0fafa; border: 2px solid #018181; border-radius: 8px;
            padding: 12px 20px; margin-bottom: 20px; font-weight: 600;
            color: #018181; display: flex; justify-content: space-between; align-items: center;
        }

        /* GTP panels */
        .gtp-panel { min-height: 200px; }
        .gtp-result-card {
            display: flex; gap: 16px; border: 2px solid #e5e7eb;
            border-radius: 10px; padding: 16px; margin-bottom: 12px;
            cursor: pointer; transition: all 0.2s;
        }
        .gtp-result-card:hover { border-color: #018181; background: #fafafa; }
        .gtp-result-card.selected { border-color: #018181; background: #f0fafa; box-shadow: 0 0 0 3px rgba(1,129,129,0.2); }
        .gtp-result-card .gtp-thumb {
            width: 100px; height: 100px; object-fit: cover; border-radius: 8px; flex-shrink: 0;
        }
        .gtp-result-card .gtp-result-info { flex: 1; }
        .gtp-result-card .gtp-result-title { font-size: 15px; font-weight: 600; color: #272d3f; margin-bottom: 4px; }
        .gtp-result-card .gtp-result-publisher { font-size: 12px; color: #018181; margin-bottom: 6px; }
        .gtp-result-card .gtp-result-snippet { font-size: 13px; color: #666; line-height: 1.4; }
        .gtp-save-btn, .gtp-delete-btn {
            position: absolute; top: 10px; right: 10px;
            background: white; border: 1.5px solid #d1d5db; border-radius: 6px;
            padding: 4px 10px; font-size: 12px; cursor: pointer;
            color: #6b7280; transition: all 0.2s; white-space: nowrap;
        }
        .gtp-save-btn:hover { border-color: #018181; color: #018181; background: #f0fafa; }
        .gtp-delete-btn { color: #dc3545; border-color: #fca5a5; }
        .gtp-delete-btn:hover { background: #fef2f2; border-color: #dc3545; }

        .gtp-details-form {
            background: #f9fafb; border: 2px solid #e5e7eb;
            border-radius: 12px; padding: 24px; margin-top: 20px;
        }
        .gtp-details-form h3 { color: #272d3f; margin-bottom: 16px; }
        .gtp-details-form .detail-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
        }
        .gtp-image-preview {
            max-width: 200px; border-radius: 8px; margin-top: 8px;
        }

        /* Review panels */
        .review-panel {
            background: #f9fafb; border: 2px solid #e5e7eb;
            border-radius: 12px; padding: 20px; margin-bottom: 16px;
        }
        .review-panel h3 {
            color: #018181; font-size: 16px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .review-content {
            font-size: 14px; line-height: 1.6; color: #333;
            min-height: 40px; padding: 8px; border-radius: 6px;
            transition: background-color 0.2s;
        }
        .review-content[contenteditable="true"]:focus {
            background: #fef3c7; outline: 2px solid #f59e0b;
        }
        .review-content[contenteditable="true"]:hover { background: #fffbeb; }

        /* Generation status */
        .gen-status {
            padding: 8px 16px; margin: 4px 0; font-size: 14px;
            color: #666; border-left: 3px solid #e5e7eb;
        }
        .gen-status.active { color: #2563eb; border-left-color: #2563eb; font-weight: 600; }
        .gen-status.done { color: #059669; border-left-color: #059669; }

        /* Brand check */
        .brand-suggestion {
            background: #fffbeb; border: 1px solid #fbbf24; border-radius: 8px;
            padding: 16px; margin-bottom: 12px;
        }
        .brand-suggestion .suggestion-text { font-size: 14px; color: #333; margin-bottom: 8px; }
        .brand-suggestion .suggestion-actions { display: flex; gap: 8px; }
        .brand-pass { background: #f0fdf4; border-color: #22c55e; }

        /* Export status */
        .export-actions {
            display: flex; gap: 12px; flex-wrap: wrap;
            margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;
        }
        .export-status {
            display: inline-block; padding: 6px 14px; border-radius: 6px;
            font-size: 13px; font-weight: 600; margin-left: 8px;
        }
        .export-status.success { background: #f0fdf4; color: #059669; }
        .export-status.error { background: #fef2f2; color: #dc3545; }

        /* Image section */
        .image-prompt-card {
            background: #f9fafb; border: 2px solid #e5e7eb;
            border-radius: 12px; padding: 20px; margin-bottom: 16px;
        }
        .image-prompt-card h4 { color: #272d3f; margin-bottom: 12px; }
        .image-preview-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px; margin-top: 20px;
        }
        .image-preview-card {
            border: 2px solid #e5e7eb; border-radius: 12px;
            overflow: hidden;
        }
        .image-preview-card img {
            width: 100%; height: 200px; object-fit: cover; display: block;
        }
        .image-preview-card .image-actions {
            padding: 12px; display: flex; gap: 8px; justify-content: center;
        }

        /* Subject line options */
        .subject-option {
            border: 2px solid #e5e7eb; border-radius: 8px;
            padding: 14px 20px; margin-bottom: 10px; cursor: pointer;
            transition: all 0.2s; font-size: 15px;
        }
        .subject-option:hover { border-color: #018181; background: #fafafa; }
        .subject-option.selected { border-color: #018181; background: #f0fafa; font-weight: 600; }

        /* Preview */
        .preview-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        .preview-toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
        .preview-subject, .preview-preheader {
            padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px;
            margin-bottom: 12px; font-size: 14px;
        }
        .preview-subject:focus, .preview-preheader:focus {
            outline: none; border-color: #3b82f6;
        }
        .preview-frame {
            border: 2px solid #e5e7eb; border-radius: 12px;
            overflow: hidden; max-height: 700px; overflow-y: auto;
            background: #f5f5f5;
        }
        .html-code-view {
            display: none; background: #1e1e1e; border-radius: 8px;
            padding: 16px; margin-top: 16px; max-height: 500px; overflow: auto;
        }
        .html-code-view pre {
            color: #d4d4d4; font-family: 'Courier New', monospace;
            font-size: 12px; white-space: pre-wrap; word-break: break-all;
        }

        /* Ontraport section */
        .ontraport-section {
            background: #f9fafb; border: 2px solid #e5e7eb;
            border-radius: 12px; padding: 24px; margin-top: 24px;
        }
        .ontraport-section h3 { color: #272d3f; margin-bottom: 16px; }

        /* Drafts & Published */
        .drafts-section, .published-section {
            padding: 30px 40px; border-top: 2px solid #e5e7eb;
        }
        .drafts-section h3, .published-section h3 {
            color: #272d3f; margin-bottom: 16px;
        }
        .card-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        .draft-card {
            background: white; border: 2px solid #e5e7eb; border-radius: 12px;
            padding: 20px; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .draft-card:hover { border-color: #018181; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .draft-card h4 { color: #272d3f; margin-bottom: 8px; }
        .draft-card .draft-meta { font-size: 13px; color: #666; }
        .draft-card .draft-time { font-size: 12px; color: #999; margin-top: 4px; }
        .draft-delete-btn {
            position: absolute; top: 8px; right: 8px;
            background: #dc3545; color: white; border: none;
            border-radius: 50%; width: 24px; height: 24px;
            font-size: 14px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;
        }
        .draft-delete-btn:hover { opacity: 1; }

        .published-card {
            background: white; border-radius: 12px; overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer;
        }
        .published-card:hover { transform: translateY(-4px); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
        .published-card .pub-header {
            height: 100px; background: #272d3f; display: flex;
            align-items: center; justify-content: center;
        }
        .published-card .pub-icon { font-size: 36px; opacity: 0.4; }
        .published-card .pub-info { padding: 16px; }
        .published-card .pub-badge {
            display: inline-block; background: #272d3f; color: white;
            padding: 4px 12px; border-radius: 4px; font-size: 12px;
            font-weight: 600; text-transform: uppercase; margin-bottom: 8px;
        }

        .placeholder-text { color: #999; font-style: italic; padding: 20px; text-align: center; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 10000;
            justify-content: center; align-items: flex-start; padding: 40px;
            overflow-y: auto;
        }
        .modal-overlay.visible { display: flex; }
        .modal-content {
            background: white; border-radius: 12px; max-width: 800px;
            width: 100%; max-height: 90vh; overflow-y: auto; position: relative;
        }
        .modal-close {
            position: sticky; top: 0; right: 0; z-index: 10;
            background: #272d3f; color: white; border: none;
            width: 40px; height: 40px; border-radius: 0 12px 0 12px;
            font-size: 20px; cursor: pointer; float: right;
        }
        .modal-close:hover { background: #dc3545; }

        /* Inline editing highlight */
        .inline-editable:focus {
            background: #fef3c7 !important;
            outline: 2px solid #f59e0b !important;
        }

        /* Recipient list */
        .recipient-list { margin-bottom: 16px; }
        .recipient-item {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 0; font-size: 14px;
        }
        .recipient-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: #018181; }

        /* Manual input section */
        .manual-input {
            background: #f9fafb; border: 2px solid #e5e7eb;
            border-radius: 10px; padding: 16px; margin-top: 16px;
        }
        .manual-input label { font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; display: block; }
        .inline-row { display: flex; gap: 8px; }
        .inline-row input { flex: 1; }

        /* Style selector */
        .style-selector { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .style-option {
            padding: 6px 16px; border: 2px solid #e5e7eb; border-radius: 20px;
            background: white; font-size: 13px; cursor: pointer; transition: all 0.2s;
        }
        .style-option:hover { border-color: #018181; }
        .style-option.selected { background: #018181; color: white; border-color: #018181; }

        /* Tone selector */
        .tone-selector { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }

        /* Content sections with link toolbar (matching jeweler) */
        .content-section {
            background: #f9fafb; border: 2px solid #e5e7eb;
            border-radius: 12px; padding: 25px; margin: 20px 0;
        }
        .content-section h3 { color: #018181; margin-bottom: 15px; font-size: 18px; }
        .editable {
            background: white; border: 2px solid #e5e7eb;
            border-radius: 8px; padding: 15px; min-height: 100px;
            font-size: 14px; line-height: 1.6; color: #333;
        }
        .editable:focus { outline: none; border-color: #018181; }
        .editable a { color: #018181; text-decoration: underline; }
        .link-toolbar { display: flex; align-items: center; gap: 4px; margin-bottom: 4px; }
        .link-toolbar-btn {
            background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px;
            padding: 4px 8px; cursor: pointer; font-size: 13px; color: #374151;
            display: inline-flex; align-items: center; gap: 4px;
        }
        .link-toolbar-btn:hover { background: #e5e7eb; }
        .link-popover {
            display: none; background: white; border: 1px solid #d1d5db;
            border-radius: 8px; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 6px;
        }
        .link-popover.show { display: block; }
        .link-popover input {
            display: block; width: 100%; padding: 6px 8px; margin-bottom: 8px;
            border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; box-sizing: border-box;
        }
        .link-popover-actions { display: flex; gap: 6px; justify-content: flex-end; }
        .link-popover-actions button {
            padding: 4px 12px; border-radius: 4px; font-size: 12px;
            cursor: pointer; border: 1px solid #d1d5db;
        }
        .link-popover-actions .link-insert-btn { background: #018181; color: white; border-color: #018181; }

        /* Previous Newsletters Section - matches jeweler */
        .previous-newsletters-section {
            background: #466F88; padding: 80px 20px; margin-top: 60px;
        }
        .previous-newsletters-section h2 {
            font-size: 36px; color: white; margin-bottom: 12px;
            font-weight: 700; text-align: center;
        }
        .previous-newsletters-section .subtitle {
            color: rgba(255,255,255,0.8); font-size: 16px;
            margin-bottom: 40px; text-align: center;
        }
        .newsletter-placeholder {
            text-align: center; padding: 60px 20px;
        }
        .newsletter-placeholder .icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }
        .newsletter-placeholder .title { color: #666; font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .newsletter-placeholder .message { color: #999; font-size: 14px; }
        /* Crop modal */
        .crop-modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 10000;
            justify-content: center; align-items: center;
        }
        .crop-modal.active { display: flex; }
        .crop-container {
            background: white; border-radius: 12px; padding: 24px;
            max-width: 700px; width: 90%; max-height: 90vh;
        }
        .crop-container h3 { margin-bottom: 16px; color: #272d3f; }
        .crop-preview { max-height: 500px; width: 100%; }
        .crop-actions {
            display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js" defer></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-right">
                <button class="start-over-btn" onclick="startOver()">Start Over</button>
                <div class="user-profile">
                    <img class="user-avatar" id="userAvatar" src="" alt="User" onclick="toggleUserDropdown(event)">
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-name" id="userDropdownName"></div>
                        <div class="user-dropdown-email" id="userDropdownEmail"></div>
                        <div class="user-dropdown-divider"></div>
                        <a class="user-dropdown-signout" href="/auth/logout">Sign out</a>
                    </div>
                </div>
            </div>
            <h1>BriteCo Consumer Newsletter</h1>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container" style="padding-top: 20px;">
            <div class="progress-text">
                <span class="progress-step-text" id="progressStepText">Step 1 of 10</span>
                <span class="progress-label" id="progressLabel">Select Month</span>
            </div>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 10%"></div>
            </div>
        </div>

        <!-- ============ STEP 1: Month Selection ============ -->
        <div id="step1" class="step active">
            <h2>Select Month</h2>
            <p class="step-description">Choose the month for your consumer newsletter</p>
            <div id="monthGrid" class="month-grid"></div>
            <div class="buttons">
                <button id="monthNextBtn" class="btn" disabled onclick="goToStep(2)">Next &rarr;</button>
            </div>
        </div>

        <!-- ============ STEP 2: YouTube Video Selection ============ -->
        <div id="step2" class="step">
            <h2>Select Videos</h2>
            <p class="step-description">Choose a BriteCo YouTube video for News of the Month and Trend Alert</p>

            <!-- Selection Slots -->
            <div class="selection-slots">
                <div class="selection-slot" id="newsOfMonthSlot">
                    <div class="slot-label">News of the Month</div>
                    <div class="slot-empty" id="newsOfMonthEmpty">Click a video below to select</div>
                    <div id="newsOfMonthFilled" style="display:none;">
                        <div class="slot-title" id="newsOfMonthTitle"></div>
                        <div class="slot-meta" id="newsOfMonthMeta"></div>
                        <span class="slot-clear" onclick="clearVideoSlot('news')">Remove</span>
                    </div>
                </div>
                <div class="selection-slot" id="trendAlertSlot">
                    <div class="slot-label">Trend Alert</div>
                    <div class="slot-empty" id="trendAlertEmpty">Click a video below to select</div>
                    <div id="trendAlertFilled" style="display:none;">
                        <div class="slot-title" id="trendAlertTitle"></div>
                        <div class="slot-meta" id="trendAlertMeta"></div>
                        <span class="slot-clear" onclick="clearVideoSlot('trend')">Remove</span>
                    </div>
                </div>
            </div>

            <!-- Tab Bar -->
            <div class="tab-bar">
                <button class="tab-btn active" id="ytTabNews" onclick="switchYoutubeTab('news')">Selecting: News of the Month</button>
                <button class="tab-btn" id="ytTabTrend" onclick="switchYoutubeTab('trend')">Selecting: Trend Alert</button>
            </div>

            <!-- Sort Bar -->
            <div class="sort-bar">
                <button class="sort-btn active" id="sortPopular" onclick="sortYoutubeVideos('popular')">Most Popular</button>
                <button class="sort-btn" id="sortRecent" onclick="sortYoutubeVideos('recent')">Most Recent</button>
            </div>

            <!-- Video Grid -->
            <div id="youtubeGrid" class="video-grid">
                <div class="loading"><div class="spinner"></div><p>Loading BriteCo videos...</p></div>
            </div>

            <!-- Manual URL -->
            <div class="manual-input">
                <label>Or paste a YouTube video URL:</label>
                <div class="inline-row">
                    <input type="text" id="youtubeUrlInput" placeholder="https://youtube.com/watch?v=...">
                    <button class="btn-small" onclick="loadVideoByUrl()">Fetch</button>
                </div>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(1)">&larr; Back</button>
                <button id="step2NextBtn" class="btn" disabled onclick="goToStep(3)">Next &rarr;</button>
            </div>
        </div>

        <!-- ============ STEP 3: Blog Article Selection ============ -->
        <div id="step3" class="step">
            <h2>Select Blog Articles</h2>
            <p class="step-description">Choose 2 articles from brite.co/blog to feature in the newsletter</p>

            <div class="selected-banner" id="blogBanner">
                <span><strong id="blogSelectedCount">0</strong> / 2 articles selected</span>
                <span id="blogBannerStatus" style="font-size:13px;color:#666;">Select 2 to continue</span>
            </div>

            <div id="blogGrid" class="blog-grid">
                <div class="loading"><div class="spinner"></div><p>Loading blog posts...</p></div>
            </div>

            <!-- Manual URL option -->
            <div class="manual-input">
                <label>Or paste a blog article URL:</label>
                <div class="inline-row">
                    <input type="text" id="blogUrlInput" placeholder="https://brite.co/blog/...">
                    <button class="btn-small" onclick="loadBlogByUrl()">Fetch</button>
                </div>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(2)">&larr; Back</button>
                <button id="step3NextBtn" class="btn" disabled onclick="goToStep(4)">Next &rarr;</button>
            </div>
        </div>

        <!-- ============ STEP 4: Guess the Price ============ -->
        <div id="step4" class="step">
            <h2>Guess the Price</h2>
            <p class="step-description">Find an interesting jewelry piece for readers to guess the price</p>

            <!-- Tabs -->
            <div class="tab-bar">
                <button class="tab-btn active" id="gtpTabSearch" onclick="switchGTPTab('search')">Search</button>
                <button class="tab-btn" id="gtpTabUrl" onclick="switchGTPTab('url')">Paste URL</button>
                <button class="tab-btn" id="gtpTabSaved" onclick="switchGTPTab('saved')">Saved Items</button>
            </div>

            <!-- Search Panel -->
            <div id="gtpSearchPanel" class="tab-panel active gtp-panel">
                <div class="inline-row" style="margin-bottom:20px;">
                    <input type="text" id="gtpSearchInput" placeholder="Search for rare or expensive jewelry pieces..." value="rare expensive jewelry 2026">
                    <select id="gtpTimeWindow" style="width:auto;padding:10px;">
                        <option value="7d">Past Week</option>
                        <option value="30d" selected>Past Month</option>
                        <option value="90d">Past 3 Months</option>
                    </select>
                    <button class="btn" onclick="searchGTP()">Search</button>
                </div>
                <div id="gtpSearchResults"></div>
            </div>

            <!-- URL Panel -->
            <div id="gtpUrlPanel" class="tab-panel gtp-panel">
                <div class="inline-row" style="margin-bottom:20px;">
                    <input type="text" id="gtpUrlInput" placeholder="https://example.com/jewelry-item...">
                    <button class="btn" onclick="fetchGTPUrl()">Fetch</button>
                </div>
                <div id="gtpUrlResult"></div>
            </div>

            <!-- Saved Panel -->
            <div id="gtpSavedPanel" class="tab-panel gtp-panel">
                <div id="gtpSavedItems">
                    <div class="loading"><div class="spinner"></div><p>Loading saved items...</p></div>
                </div>
            </div>

            <!-- Selected Item Details Form -->
            <div id="gtpDetailsForm" class="gtp-details-form" style="display:none;">
                <h3>Item Details <span id="gtpAIBadge" style="font-size:12px;background:#018181;color:white;padding:2px 10px;border-radius:10px;margin-left:8px;display:none;">AI Generated</span></h3>
                <div id="gtpGeneratingDetails" style="display:none;text-align:center;padding:20px;">
                    <div class="spinner"></div>
                    <p>AI is generating item details...</p>
                </div>
                <div id="gtpDetailFields">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="gtpTitle">
                    </div>
                    <div class="form-group">
                        <label>Image URL</label>
                        <div class="inline-row">
                            <input type="text" id="gtpImageUrl" placeholder="https://...">
                            <button class="btn-small" onclick="previewGTPImage()">Preview</button>
                            <button class="btn-small" onclick="clearGTPImage()" style="background:#dc3545;" title="Remove image">&#10005;</button>
                        </div>
                        <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
                            <label class="btn-small" style="cursor:pointer;display:inline-flex;align-items:center;gap:4px;margin:0;background:#466f88;">
                                <input type="file" id="gtpFileUpload" accept="image/*" onchange="handleGTPFileUpload(event)" style="display:none;">
                                Upload Image
                            </label>
                            <button class="btn-small" id="gtpCropBtn" onclick="openGTPCropper()" style="display:none;background:#008181;">Crop / Reposition</button>
                        </div>
                        <div id="gtpImagePreviewWrap" style="position:relative;display:inline-block;margin-top:8px;">
                            <img id="gtpImagePreview" class="gtp-image-preview" style="display:none;">
                            <button id="gtpImageClearOverlay" onclick="clearGTPImage()" style="display:none;position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:14px;line-height:24px;padding:0;">&times;</button>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="form-group">
                            <label>Material</label>
                            <input type="text" id="gtpMaterial" placeholder="e.g., 18k gold with sapphires">
                        </div>
                        <div class="form-group">
                            <label>Found In</label>
                            <input type="text" id="gtpFoundIn" placeholder="e.g., auction house, private collection">
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="form-group">
                            <label>Where It Lives</label>
                            <input type="text" id="gtpWhereItLives" placeholder="e.g., Smithsonian, private owner">
                        </div>
                        <div class="form-group">
                            <label>Source Link</label>
                            <input type="text" id="gtpSourceLink" placeholder="https://...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Fun Fact</label>
                        <textarea id="gtpFunFact" rows="2" placeholder="An interesting fact about this piece..."></textarea>
                    </div>
                    <div style="margin-top:12px;">
                        <button class="btn-small" onclick="saveGTPItem()">Save for Later</button>
                        <button class="btn-small btn-small" style="background:#3b82f6;margin-left:8px;" onclick="regenerateGTPDetails()">Regenerate Details</button>
                    </div>
                </div>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(3)">&larr; Back</button>
                <button id="step4NextBtn" class="btn" disabled onclick="goToStep(5)">Next &rarr;</button>
            </div>
        </div>

        <!-- ============ STEP 4b: Generating Intro & Tip (Loading) ============ -->
        <div id="step4b" class="step">
            <div class="loading">
                <div class="spinner"></div>
                <h3>Generating Intro &amp; Quick Tip...</h3>
                <p style="color: #666;">Claude is crafting a personalized intro and seasonal tip for your newsletter</p>
            </div>
        </div>

        <!-- ============ STEP 5: Intro & Quick Tip ============ -->
        <div id="step5" class="step">
            <h2>Intro &amp; Quick Tip</h2>
            <p class="step-description">Write the newsletter intro and a seasonal jewelry care tip</p>

            <div class="form-group">
                <label>Newsletter Intro</label>
                <textarea id="introContent" rows="4" placeholder="Write a fun, engaging opening for this month's newsletter... or click AI Generate below"></textarea>
                <div class="textarea-actions">
                    <span class="word-count" id="introWordCount">0 words</span>
                    <div style="display:flex;gap:8px;">
                        <button class="btn-small" onclick="aiGenerateIntro()">AI Generate</button>
                        <button class="btn-small" style="background:#6b7280;" onclick="aiRewriteIntro()">AI Rewrite</button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Quick Tip <span style="font-size:12px;color:#999;font-weight:400;">(seasonal jewelry care tip)</span></label>
                <textarea id="quickTipContent" rows="3" placeholder="A quick seasonal jewelry care tip for readers... or click AI Generate below"></textarea>
                <div class="textarea-actions">
                    <span class="word-count" id="quickTipWordCount">0 words</span>
                    <button class="btn-small" onclick="generateQuickTip()">AI Generate</button>
                </div>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(4)">&larr; Back</button>
                <button class="btn btn-green" onclick="saveDraft(); showSaveConfirm(this);">Save Draft</button>
                <button class="btn" onclick="generateContent()">Generate Newsletter &rarr;</button>
            </div>
        </div>

        <!-- ============ STEP 6: Content Generation (Loading) ============ -->
        <div id="step6" class="step">
            <div class="loading">
                <div class="spinner"></div>
                <h3 id="generatingTitle">Generating Newsletter Content...</h3>
                <p id="generatingStatus">Claude is crafting your consumer newsletter sections</p>
                <div style="margin-top:24px;text-align:left;max-width:400px;margin-left:auto;margin-right:auto;">
                    <div class="gen-status" id="genIntroStatus">Intro &amp; Agenda: Waiting...</div>
                    <div class="gen-status" id="genNewsStatus">News of the Month: Waiting...</div>
                    <div class="gen-status" id="genTrendStatus">Trend Alert: Waiting...</div>
                    <div class="gen-status" id="genGTPStatus">Guess the Price: Waiting...</div>
                    <div class="gen-status" id="genTipStatus">Quick Tip: Waiting...</div>
                </div>
            </div>
        </div>

        <!-- ============ STEP 6b: Review Generated Content ============ -->
        <div id="step6b" class="step">
            <h2>Review Generated Content</h2>
            <p class="step-description">Review and edit the AI-generated content. Use the link button to insert hyperlinks.</p>

            <div class="content-section">
                <h3>Introduction</h3>
                <div class="link-toolbar"><button class="link-toolbar-btn" onclick="showLinkPopover('fc-intro')" type="button">&#128279; Insert Link</button></div>
                <div class="link-popover" id="lp-fc-intro">
                    <input type="text" placeholder="Display text" class="lp-text">
                    <input type="text" placeholder="https://..." class="lp-url">
                    <div class="link-popover-actions">
                        <button type="button" onclick="hideLinkPopover('fc-intro')">Cancel</button>
                        <button type="button" class="link-insert-btn" onclick="insertLink('fc-intro')">Insert</button>
                    </div>
                </div>
                <div class="editable" contenteditable="true" id="fc-intro"></div>
            </div>

            <div class="content-section">
                <h3>What's Inside (Agenda)</h3>
                <div class="editable" contenteditable="true" id="fc-agenda"></div>
            </div>

            <div class="content-section">
                <h3>News of the Month - Description
                    <button class="btn-small" onclick="aiRewriteSection('news_of_month')" style="float:right;">AI Rewrite</button>
                </h3>
                <div class="link-toolbar"><button class="link-toolbar-btn" onclick="showLinkPopover('fc-news')" type="button">&#128279; Insert Link</button></div>
                <div class="link-popover" id="lp-fc-news">
                    <input type="text" placeholder="Display text" class="lp-text">
                    <input type="text" placeholder="https://..." class="lp-url">
                    <div class="link-popover-actions">
                        <button type="button" onclick="hideLinkPopover('fc-news')">Cancel</button>
                        <button type="button" class="link-insert-btn" onclick="insertLink('fc-news')">Insert</button>
                    </div>
                </div>
                <div class="editable" contenteditable="true" id="fc-news"></div>
            </div>

            <div class="content-section">
                <h3>Trend Alert - Description
                    <button class="btn-small" onclick="aiRewriteSection('trend_alert')" style="float:right;">AI Rewrite</button>
                </h3>
                <div class="link-toolbar"><button class="link-toolbar-btn" onclick="showLinkPopover('fc-trend')" type="button">&#128279; Insert Link</button></div>
                <div class="link-popover" id="lp-fc-trend">
                    <input type="text" placeholder="Display text" class="lp-text">
                    <input type="text" placeholder="https://..." class="lp-url">
                    <div class="link-popover-actions">
                        <button type="button" onclick="hideLinkPopover('fc-trend')">Cancel</button>
                        <button type="button" class="link-insert-btn" onclick="insertLink('fc-trend')">Insert</button>
                    </div>
                </div>
                <div class="editable" contenteditable="true" id="fc-trend"></div>
            </div>

            <div class="content-section">
                <h3>Guess the Price - Question
                    <button class="btn-small" onclick="aiRewriteSection('guess_the_price')" style="float:right;">AI Rewrite</button>
                </h3>
                <div class="editable" contenteditable="true" id="fc-gtp"></div>
            </div>

            <div class="content-section">
                <h3>Quick Tip
                    <button class="btn-small" onclick="aiRewriteSection('quick_tip')" style="float:right;">AI Rewrite</button>
                </h3>
                <div class="link-toolbar"><button class="link-toolbar-btn" onclick="showLinkPopover('fc-tip')" type="button">&#128279; Insert Link</button></div>
                <div class="link-popover" id="lp-fc-tip">
                    <input type="text" placeholder="Display text" class="lp-text">
                    <input type="text" placeholder="https://..." class="lp-url">
                    <div class="link-popover-actions">
                        <button type="button" onclick="hideLinkPopover('fc-tip')">Cancel</button>
                        <button type="button" class="link-insert-btn" onclick="insertLink('fc-tip')">Insert</button>
                    </div>
                </div>
                <div class="editable" contenteditable="true" id="fc-tip"></div>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(5)">&larr; Back</button>
                <button class="btn btn-green" onclick="saveDraft(); showSaveConfirm(this);">Save Draft</button>
                <button class="btn" onclick="goToStep(7)">Brand Check &rarr;</button>
            </div>
        </div>

        <!-- ============ STEP 7: Brand Check (Loading) ============ -->
        <div id="step7" class="step">
            <div class="loading" id="brandCheckLoading">
                <div class="spinner"></div>
                <h3>Checking Brand Guidelines...</h3>
                <p style="color: #666;">AI is reviewing content for tone, style, and brand consistency</p>
            </div>
        </div>

        <!-- ============ STEP 7b: Brand Check Results + Export ============ -->
        <div id="step7b" class="step">
            <h2>Brand Guidelines Check</h2>
            <p class="step-description">Your content has been reviewed for brand consistency.</p>

            <!-- Brand Check Results -->
            <div id="brandCheckResults" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;"></div>

            <!-- Export to Google Docs & Email Section -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                <h3 style="margin: 0 0 10px 0; color: #008181;">Export to Google Docs &amp; Email</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 20px;">Hit export and once complete, you can auto email the exported link to your team.</p>

                <!-- Primary Export Button -->
                <button class="btn btn-blue" onclick="exportToDocs()" id="exportBtn">
                    <span id="exportBtnText">Export to Google Docs</span>
                </button>

                <!-- Export Result -->
                <div id="exportDocsResult" style="display: none; margin-top: 20px; padding: 15px; border-radius: 6px;"></div>

                <div id="docsLinkContainer" style="display:none;margin-top:16px;">
                    <a id="docsLink" href="#" target="_blank" style="color:#018181;font-weight:600;">
                        Open Google Doc &rarr;
                    </a>
                </div>

                <!-- Email Section (hidden until export succeeds) -->
                <div id="emailAfterExportSection" style="display: none; margin-top: 20px; border-top: 2px solid #e5e7eb; padding-top: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #374151;">Email the Google Doc Link</h4>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; font-size: 14px;">Select recipients:</label>

                        <div id="recipientList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; padding: 12px; background: #f9fafb; border-radius: 6px;"></div>

                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">Additional emails (comma-separated):</label>
                        <input type="text" id="additionalEmails" placeholder="email1@example.com, email2@example.com" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 4px; font-size: 14px; margin-bottom: 15px;">

                        <button class="btn btn-green" onclick="sendEmailNotification()" id="sendEmailBtn">
                            <span id="sendEmailBtnText">Send Email</span>
                        </button>

                        <div id="emailSendResult" style="display: none; margin-top: 15px; padding: 12px; border-radius: 6px;"></div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px; text-align: center;">
                <button class="btn btn-green" onclick="saveDraft(); showSaveConfirm(this);" style="padding: 10px 30px;">Save Draft</button>
                <p style="margin: 8px 0 0 0; font-size: 13px; color: #666;">Save your progress to resume later</p>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="showStep('6b')">&larr; Back to Edit</button>
                <button class="btn" onclick="goToStep(8)">Continue to Images &rarr;</button>
            </div>
        </div>

        <!-- ============ STEP 7c: Generating Image Prompts (Loading) ============ -->
        <div id="step7c" class="step">
            <div class="loading">
                <div class="spinner"></div>
                <h3>Generating Image Prompts...</h3>
                <p style="color: #666;">Analyzing your newsletter content with Claude AI...</p>
            </div>
        </div>

        <!-- ============ STEP 8: Image Generation ============ -->
        <div id="step8" class="step">
            <h2>Image Generation</h2>
            <p class="step-description">Generate or upload images for the Quick Tip and Guess the Price sections</p>

            <p style="color:#6b7280;font-size:13px;margin-bottom:15px;">Image prompts were auto-generated from your content. Edit them below, choose a style, then generate.</p>
            <div style="margin-bottom:20px;">
                <button class="btn-small" onclick="autoGenerateImagePrompts()" id="autoPromptBtn" style="background:#466F88;">Regenerate Image Prompts</button>
            </div>

            <div class="image-prompt-card" id="quickTipImageCard">
                <h4>Quick Tip Image</h4>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">Image Style:</label>
                    <select id="quickTipImageStyle" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; background: white;" onchange="updatePromptWithStyle('quickTip')">
                        <option value="photorealistic">Photorealistic (Default)</option>
                        <option value="sketch">Sketch / Illustration</option>
                        <option value="watercolor">Watercolor</option>
                        <option value="modern-flat">Modern Flat Design</option>
                        <option value="magazine">Magazine Editorial</option>
                        <option value="cartoon">Cartoon</option>
                        <option value="infographic">Infographic / Data Viz</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Image Prompt</label>
                    <textarea id="quickTipImagePrompt" rows="3" placeholder="Describe the image you want for the quick tip section..."></textarea>
                </div>
                <div style="display:flex;gap:8px;">
                    <button class="btn-small" onclick="generateSingleImage('quick_tip')">Generate Image</button>
                    <label class="btn-small" style="background:#6b7280;cursor:pointer;">
                        Upload Image
                        <input type="file" accept="image/*" style="display:none;" onchange="uploadCustomImage('quick_tip', this)">
                    </label>
                </div>
                <div id="quickTipImageResult" style="margin-top:12px;"></div>
            </div>

            <div class="image-prompt-card" id="gtpImageCard">
                <h4>Guess the Price Image</h4>
                <div id="gtpExistingImageNote" style="display:none;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="color:#059669;font-weight:600;">Using uploaded image URL</span>
                        <button onclick="clearGTPExistingImage()" style="background:#dc3545;color:white;border:none;border-radius:4px;padding:3px 10px;font-size:12px;cursor:pointer;font-weight:600;" title="Remove this image and use AI-generated instead">&times; Remove</button>
                    </div>
                    <img id="gtpExistingImageThumb" style="display:block;max-width:200px;border-radius:8px;margin-top:8px;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">Image Style:</label>
                    <select id="gtpImageStyle" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; background: white;" onchange="updatePromptWithStyle('gtp')">
                        <option value="photorealistic">Photorealistic (Default)</option>
                        <option value="sketch">Sketch / Illustration</option>
                        <option value="watercolor">Watercolor</option>
                        <option value="modern-flat">Modern Flat Design</option>
                        <option value="magazine">Magazine Editorial</option>
                        <option value="cartoon">Cartoon</option>
                        <option value="infographic">Infographic / Data Viz</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Image Prompt (optional if image URL already set)</label>
                    <textarea id="gtpImagePrompt" rows="3" placeholder="Describe the image for the Guess the Price section..."></textarea>
                </div>
                <div style="display:flex;gap:8px;">
                    <button class="btn-small" onclick="generateSingleImage('guess_the_price')">Generate Image</button>
                    <label class="btn-small" style="background:#6b7280;cursor:pointer;">
                        Upload Image
                        <input type="file" accept="image/*" style="display:none;" onchange="uploadCustomImage('guess_the_price', this)">
                    </label>
                </div>
                <div id="gtpImageResult" style="margin-top:12px;"></div>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="showStep('7b')">&larr; Back</button>
                <button class="btn btn-green" onclick="saveDraft(); showSaveConfirm(this);">Save Draft</button>
                <button class="btn" onclick="showStep('8b')">Review Images &rarr;</button>
            </div>
        </div>

        <!-- ============ STEP 8b: Image Review ============ -->
        <div id="step8b" class="step">
            <h2>Review Images</h2>
            <p class="step-description">Review your generated/uploaded images before moving on</p>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px;">
                <!-- Quick Tip Image Review -->
                <div style="background:#f9fafb;border:2px solid #e5e7eb;border-radius:12px;padding:20px;">
                    <h4 style="color:#018181;margin:0 0 12px 0;">Quick Tip Image</h4>
                    <div id="reviewQuickTipImage" style="min-height:150px;display:flex;align-items:center;justify-content:center;">
                        <p style="color:#999;">No image generated</p>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px;">
                        <button class="btn-small" onclick="showStep(8)">Regenerate</button>
                        <label class="btn-small" style="background:#6b7280;cursor:pointer;">
                            Upload New
                            <input type="file" accept="image/*" style="display:none;" onchange="uploadCustomImage('quick_tip', this); populateImageReview();">
                        </label>
                    </div>
                </div>

                <!-- Guess the Price Image Review -->
                <div style="background:#f9fafb;border:2px solid #e5e7eb;border-radius:12px;padding:20px;">
                    <h4 style="color:#018181;margin:0 0 12px 0;">Guess the Price Image</h4>
                    <div id="reviewGTPImage" style="min-height:150px;display:flex;align-items:center;justify-content:center;">
                        <p style="color:#999;">No image generated</p>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px;">
                        <button class="btn-small" onclick="showStep(8)">Regenerate</button>
                        <label class="btn-small" style="background:#6b7280;cursor:pointer;">
                            Upload New
                            <input type="file" accept="image/*" style="display:none;" onchange="uploadCustomImage('guess_the_price', this);">
                        </label>
                        <button class="btn-small" style="background:#008181;" onclick="openGTPCropperFromReview()">Crop</button>
                    </div>
                </div>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="showStep(8)">&larr; Back to Images</button>
                <button class="btn btn-green" onclick="saveDraft(); showSaveConfirm(this);">Save Draft</button>
                <button class="btn" onclick="goToStep(9)">Subject Line &rarr;</button>
            </div>
        </div>

        <!-- ============ STEP 9: Subject Line & Preheader ============ -->
        <div id="step9" class="step">
            <h2>Subject Line &amp; Preheader</h2>
            <p class="step-description">Choose or write the email subject line and preheader text</p>

            <!-- Tone Selection (shown first, hidden after generation) -->
            <div id="toneSelection" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #3b82f6;">
                <h3 style="margin: 0 0 10px 0;">Select Tone</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Choose the tone for your subject line and preheader</p>
                <select id="subjectToneSelect" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; background: white; margin-bottom: 15px;">
                    <option value="playful">Playful &amp; Fun</option>
                    <option value="witty">Witty &amp; Clever</option>
                    <option value="friendly">Friendly &amp; Conversational</option>
                    <option value="informative">Informative &amp; Professional</option>
                    <option value="exclusive">Exclusive &amp; Premium</option>
                </select>
                <button class="btn" onclick="generateSubjectLinesWithTone()" style="width: 100%;">Generate Subject Lines</button>
            </div>

            <!-- Loading Screen -->
            <div id="subjectLineLoading" style="display: none;">
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>Generating Options...</h3>
                    <p style="color: #666;">Claude is reviewing your newsletter content...</p>
                </div>
            </div>

            <!-- Subject Line Options (shown after generation) -->
            <div id="subjectLineResults" style="display: none;">
                <!-- Subject Lines -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                    <h3 style="margin: 0 0 15px 0;">Subject Line Options</h3>
                    <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Choose one or edit to create your own</p>
                    <div id="subjectLineList" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;"></div>
                    <div style="margin-top: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px;">Your Subject Line:</label>
                        <input type="text" id="finalSubjectLine" placeholder="Selected or custom subject line" style="width: 100%; padding: 12px; border: 2px solid #3b82f6; border-radius: 4px; font-size: 16px; font-weight: 500;">
                    </div>
                </div>

                <!-- Preheader Options -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                    <h3 style="margin: 0 0 15px 0;">Preheader Options</h3>
                    <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Choose one or write your own preview text</p>
                    <div id="preheaderList" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;"></div>
                    <div style="margin-top: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px;">Your Preheader:</label>
                        <input type="text" id="finalPreheader" placeholder="Brief preview text for email clients..." style="width: 100%; padding: 12px; border: 2px solid #3b82f6; border-radius: 4px; font-size: 14px;">
                    </div>
                </div>

                <!-- Regenerate -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn-small" onclick="regenerateSubjectLines()" style="background:#466F88;">Regenerate with Different Tone</button>
                </div>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(8)">&larr; Back</button>
                <button class="btn btn-green" onclick="saveDraft(); showSaveConfirm(this);">Save Draft</button>
                <button class="btn" onclick="goToStep(10)">Preview &rarr;</button>
            </div>
        </div>

        <!-- ============ STEP 10: Preview + Publish ============ -->
        <div id="step10" class="step">
            <h2>Newsletter Preview</h2>
            <p class="step-description">Review your complete newsletter before sending</p>

            <!-- Editing Instructions -->
            <div style="background: #e0f2fe; border: 2px solid #0284c7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; font-size: 14px; color: #0c4a6e;"><strong>Live Editing:</strong> Click any text in the preview below to edit it directly.</p>
            </div>

            <!-- Subject Line & Preheader Display -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #3b82f6;">
                <h3 style="margin: 0 0 15px 0;">Email Info</h3>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; color: #666;">Subject Line:</label>
                    <div id="previewSubjectLine" contenteditable="true" style="padding: 12px; background: #f9fafb; border-radius: 6px; font-size: 16px; font-weight: 500; color: #333; border: 2px solid transparent; transition: border-color 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='transparent'; saveSubjectEdit(this)">Your subject line will appear here</div>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; color: #666;">Preheader:</label>
                    <div id="previewPreheader" contenteditable="true" style="padding: 12px; background: #f9fafb; border-radius: 6px; font-size: 14px; color: #666; border: 2px solid transparent; transition: border-color 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='transparent'; savePreheaderEdit(this)">Your preheader will appear here</div>
                </div>
            </div>

            <div id="newsletterPreview" style="background: #e8e8e8; border: 1px solid #ddd; border-radius: 8px; padding: 0; max-width: 100%; margin: 20px auto; overflow: auto;">
                <!-- Full newsletter HTML will be displayed here -->
            </div>

            <div class="html-code-view" id="htmlCodeView">
                <pre id="htmlCode"></pre>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="savePreviewEdits()" style="background: #0284c7; padding: 12px 28px; font-size: 15px;">Save Changes to HTML</button>
                <span id="saveStatus" style="margin-left: 10px; font-size: 14px; color: #166534; display: none;">Changes saved!</span>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(9)">&larr; Back to Subject Line</button>
                <button class="btn btn-secondary" onclick="toggleHTMLCode()" id="htmlViewBtn">View HTML Code</button>
                <button class="btn btn-secondary" style="background:#3b82f6;" onclick="copyHTMLCode()">Copy HTML</button>
                <button class="btn" onclick="goToStep(11)">Push to Ontraport &rarr;</button>
            </div>
        </div>

        <!-- ============ STEP 11: Push to Ontraport ============ -->
        <div id="step11" class="step">
            <h2>Push to Ontraport</h2>
            <p class="step-description">Send your newsletter to Ontraport with pre-configured BriteCo settings</p>

            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                <div style="padding: 15px; background-color: #f0fdf4; border-radius: 6px; border-left: 4px solid #22c55e; margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; color: #166534; margin-bottom: 5px;">Subject Line:</label>
                    <input type="text" id="ontraportSubjectInput" style="width: 100%; padding: 10px; font-size: 16px; color: #272d3f; border: 2px solid #22c55e; border-radius: 6px; background: #ffffff; box-sizing: border-box;" placeholder="Enter subject line..." />
                </div>

                <button class="btn" onclick="pushToOntraport()" id="ontraportBtn" style="width: 100%; padding: 15px; font-size: 16px; background: #018181;">
                    <span id="ontraportBtnText">Push to Ontraport</span>
                </button>

                <div id="ontraportResult" style="display: none; margin-top: 20px; padding: 15px; border-radius: 6px;"></div>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(10)">&larr; Back to Preview</button>
            </div>
        </div>

    </div>

    <!-- Saved Drafts Section -->
    <div id="draftsSection" class="previous-newsletters-section">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="margin-bottom: 40px; text-align: center;">
                <h2>Saved Drafts</h2>
                <p class="subtitle">Resume an in-progress newsletter</p>
            </div>
            <div id="draftsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 28px;"></div>
            <div id="draftsEmpty" class="newsletter-placeholder">
                <div class="icon">&#128221;</div>
                <h3 class="title">No Drafts In Progress</h3>
                <p class="message">Any newsletters in progress will appear here automatically</p>
            </div>
        </div>
    </div>

    <!-- Published Newsletter View Modal -->
    <div id="publishedModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; overflow: auto;">
        <div style="max-width: 800px; margin: 40px auto; background: white; border-radius: 12px; position: relative;">
            <button onclick="closePublishedModal()" style="position: absolute; top: 20px; right: 20px; background: white; border: 2px solid #e5e7eb; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; z-index: 10;">&times;</button>
            <div id="publishedModalContent" style="padding: 20px; max-height: 80vh; overflow: auto;"></div>
        </div>
    </div>

    <!-- Previous Newsletters Section -->
    <div class="previous-newsletters-section">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="margin-bottom: 40px; text-align: center;">
                <h2>Previous Newsletters</h2>
                <p class="subtitle">View past newsletters sent to your subscribers</p>
            </div>
            <div id="publishedGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 28px;"></div>
            <div id="publishedEmpty" class="newsletter-placeholder">
                <div class="icon">&#128237;</div>
                <h3 class="title">No Previous Newsletters</h3>
                <p class="message">Published newsletters will appear here</p>
            </div>
        </div>
    </div>

    <script>
    // ============================================================
    // STATE MANAGEMENT
    // ============================================================
    const API_BASE = window.location.origin;
    let selectedMonth = '';
    let currentStep = 1;
    const totalSteps = 11;
    let currentYoutubeTab = 'news';
    let currentYoutubeSort = 'popular';
    let currentGTPTab = 'search';
    let selectedTone = 'playful';

    let youtubeVideos = [];
    let youtubeNextPageToken = null;
    let blogPosts = [];
    let blogCurrentPage = 1;
    let blogHasMore = true;
    let introAndTipGenerated = false;

    let selectedContent = {
        news_of_month: null,
        trend_alert: null,
        blog_1: null,
        blog_2: null,
        guess_the_price: null
    };

    let generatedContent = {};
    let generatedImages = {};
    let generatedPrompts = {};
    let promptsAlreadyGenerated = false;
    let exportedDocUrl = '';
    let renderedEmailHTML = '';

    const TEAM_MEMBERS = [
        { name: 'Dylanne Crugnale', email: 'dylanne.crugnale@brite.co' },
        { name: 'Selena Fragassi', email: 'selena.fragassi@brite.co' }
    ];

    const stepLabels = {
        1: 'Select Month', 2: 'Select Videos', 3: 'Blog Articles',
        4: 'Guess the Price', '4b': 'Generating...', 5: 'Intro & Quick Tip', 6: 'Generating...',
        '6b': 'Review Content', 7: 'Brand Check...', '7b': 'Brand Check & Export',
        '7c': 'Generating Prompts...', 8: 'Image Generation', '8b': 'Review Images', 9: 'Subject Line', 10: 'Preview',
        11: 'Push to Ontraport'
    };

    const months = [
        { name: 'january', season: 'winter' }, { name: 'february', season: 'winter' },
        { name: 'march', season: 'spring' }, { name: 'april', season: 'spring' },
        { name: 'may', season: 'spring' }, { name: 'june', season: 'summer' },
        { name: 'july', season: 'summer' }, { name: 'august', season: 'summer' },
        { name: 'september', season: 'fall' }, { name: 'october', season: 'fall' },
        { name: 'november', season: 'fall' }, { name: 'december', season: 'winter' }
    ];

    // ============================================================
    // NAVIGATION
    // ============================================================
    function goToStep(step) {
        const savePoints = [5, '6b', '7b', 8, 9, 10, 11];
        if (selectedMonth && (savePoints.includes(step) || savePoints.includes(String(step)))) {
            saveDraft();
        }
        if (step === 7) { runBrandCheck(); return; }
        if (step === 10) { try { populatePreview(); } catch(err) { console.error('Preview error:', err); } }
        if (step === 11) {
            const subjectLine = document.getElementById('finalSubjectLine')?.value || 'BriteCo Newsletter - ' + selectedMonth;
            const subjectInput = document.getElementById('ontraportSubjectInput');
            if (subjectInput) subjectInput.value = subjectLine;
        }
        if (step === 2 && youtubeVideos.length === 0) loadYoutubeVideos();
        if (step === 3 && blogPosts.length === 0) loadBlogPosts();
        // Auto-generate intro & quick tip when entering Step 5 - show loading first
        if (step === 5 && !introAndTipGenerated) {
            showStep('4b');
            autoGenerateIntroAndTip().then(() => {
                currentStep = 5;
                document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                document.getElementById('step5').classList.add('active');
                updateProgressBar();
            });
            return;
        }
        // Auto-generate image prompts when entering Step 8 - show loading first
        if (step === 8) {
            setupImageStep();
            if (!promptsAlreadyGenerated) {
                showStep('7c');
                autoGenerateImagePrompts().then(() => {
                    currentStep = 8;
                    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                    document.getElementById('step8').classList.add('active');
                    updateProgressBar();
                });
                return;
            }
        }
        if (step === 9) { autoGenerateSubjectLinesIfNeeded(); }
        currentStep = step;
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        const el = document.getElementById('step' + step);
        if (el) el.classList.add('active');
        updateProgressBar();
        window.scrollTo(0, 0);
    }

    function showStep(stepId) {
        const savePoints = ['6b', '7b'];
        if (selectedMonth && savePoints.includes(stepId)) saveDraft();
        currentStep = stepId;
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        const el = document.getElementById('step' + stepId);
        if (el) el.classList.add('active');
        updateProgressBar();
        window.scrollTo(0, 0);
        if (stepId === '8b') populateImageReview();
    }

    function updateProgressBar() {
        const stepMap = { 1:1, 2:2, 3:3, 4:4, '4b':5, 5:5, 6:6, '6b':6, 7:7, '7b':7, '7c':8, 8:8, '8b':8, 9:9, 10:10, 11:11 };
        const num = stepMap[currentStep] || 1;
        const pct = (num / totalSteps) * 100;
        document.getElementById('progressBar').style.width = pct + '%';
        document.getElementById('progressStepText').textContent = `Step ${num} of ${totalSteps}`;
        document.getElementById('progressLabel').textContent = stepLabels[currentStep] || '';
    }

    function startOver() {
        if (confirm('Start over? This will return to the first step.')) goToStep(1);
    }

    // ============================================================
    // MONTH SELECTION
    // ============================================================
    function initMonthGrid() {
        const grid = document.getElementById('monthGrid');
        if (!grid) return;
        months.forEach(m => {
            const card = document.createElement('div');
            card.className = 'month-card';
            card.innerHTML = `<span class="name">${m.name.charAt(0).toUpperCase() + m.name.slice(1)}</span><span class="season">${m.season}</span>`;
            card.onclick = () => selectMonth(m.name, card);
            grid.appendChild(card);
        });
    }

    function selectMonth(month, element) {
        selectedMonth = month;
        document.querySelectorAll('.month-card').forEach(c => c.classList.remove('selected'));
        element.classList.add('selected');
        document.getElementById('monthNextBtn').disabled = false;
    }

    // ============================================================
    // YOUTUBE VIDEO SELECTION
    // ============================================================
    async function loadYoutubeVideos(sort, append) {
        sort = sort || currentYoutubeSort;
        currentYoutubeSort = sort;
        const grid = document.getElementById('youtubeGrid');
        if (!append) {
            grid.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading BriteCo videos...</p></div>';
            youtubeNextPageToken = null;
        }
        try {
            let url = `${API_BASE}/api/youtube/videos?sort=${sort}&max_results=50`;
            if (append && youtubeNextPageToken) url += `&page_token=${youtubeNextPageToken}`;
            const resp = await fetch(url);
            const data = await resp.json();
            if (data.success && data.videos) {
                if (append) {
                    youtubeVideos = youtubeVideos.concat(data.videos);
                } else {
                    youtubeVideos = data.videos;
                }
                youtubeNextPageToken = data.next_page_token || null;
                renderYoutubeGrid();
            } else {
                if (!append) grid.innerHTML = '<p style="color:#dc3545;text-align:center;">Failed to load videos. ' + (data.error || '') + '</p>';
            }
        } catch (e) {
            if (!append) grid.innerHTML = '<p style="color:#dc3545;text-align:center;">Error loading videos: ' + e.message + '</p>';
        }
    }

    function renderYoutubeGrid() {
        const grid = document.getElementById('youtubeGrid');
        grid.innerHTML = '';
        if (!youtubeVideos.length) {
            grid.innerHTML = '<p style="text-align:center;color:#999;">No videos found.</p>';
            return;
        }
        youtubeVideos.forEach((v, idx) => {
            const isSelectedNews = selectedContent.news_of_month && selectedContent.news_of_month.video_id === v.video_id;
            const isSelectedTrend = selectedContent.trend_alert && selectedContent.trend_alert.video_id === v.video_id;
            const card = document.createElement('div');
            card.className = 'video-card' + (isSelectedNews || isSelectedTrend ? ' selected' : '');
            const badge = isSelectedNews ? 'NEWS' : (isSelectedTrend ? 'TREND' : '');
            const views = v.view_count ? formatNumber(v.view_count) + ' views' : '';
            const date = v.published_at ? formatRelativeDate(v.published_at) : '';
            card.innerHTML = `
                <div class="selected-badge">${badge}</div>
                <a href="${v.url || 'https://youtube.com/watch?v=' + v.video_id}" target="_blank" onclick="event.stopPropagation();" style="position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.7);color:white;padding:4px 8px;border-radius:4px;font-size:11px;text-decoration:none;z-index:2;">&#9654; YouTube</a>
                <img class="thumb" src="${v.thumbnail_url || ''}" alt="${escapeHtml(v.title)}" loading="lazy">
                <div class="video-info">
                    <div class="video-title">${escapeHtml(v.title)}</div>
                    <div class="video-meta">
                        <span>${views}</span>
                        <span>${date}</span>
                    </div>
                </div>
            `;
            card.onclick = () => selectYoutubeVideo(v);
            grid.appendChild(card);
        });
        // Video count + Load More
        const footerDiv = document.createElement('div');
        footerDiv.style.cssText = 'text-align:center;padding:16px 0;grid-column:1/-1;';
        let footerHtml = '<p style="color:#999;font-size:13px;margin:0 0 12px 0;">Showing ' + youtubeVideos.length + ' video' + (youtubeVideos.length !== 1 ? 's' : '') + '</p>';
        if (youtubeNextPageToken) {
            footerHtml += '<button class="btn" onclick="loadYoutubeVideos(null, true)" style="background:#466F88;font-size:15px;padding:10px 28px;">Load More Videos</button>';
        }
        footerDiv.innerHTML = footerHtml;
        grid.appendChild(footerDiv);
    }

    function selectYoutubeVideo(video) {
        const slotKey = currentYoutubeTab === 'news' ? 'news_of_month' : 'trend_alert';
        const otherKey = slotKey === 'news_of_month' ? 'trend_alert' : 'news_of_month';
        if (selectedContent[otherKey] && selectedContent[otherKey].video_id === video.video_id) {
            alert('This video is already selected for the other section. Please choose a different video.');
            return;
        }
        selectedContent[slotKey] = video;
        updateVideoSlots();
        renderYoutubeGrid();
        updateStep2NextButton();
    }

    function clearVideoSlot(tab) {
        const key = tab === 'news' ? 'news_of_month' : 'trend_alert';
        selectedContent[key] = null;
        updateVideoSlots();
        renderYoutubeGrid();
        updateStep2NextButton();
    }

    function updateVideoSlots() {
        // News of Month slot
        const news = selectedContent.news_of_month;
        if (news) {
            document.getElementById('newsOfMonthSlot').classList.add('filled');
            document.getElementById('newsOfMonthEmpty').style.display = 'none';
            document.getElementById('newsOfMonthFilled').style.display = 'block';
            document.getElementById('newsOfMonthTitle').textContent = news.title;
            document.getElementById('newsOfMonthMeta').textContent = (news.view_count ? formatNumber(news.view_count) + ' views' : '');
        } else {
            document.getElementById('newsOfMonthSlot').classList.remove('filled');
            document.getElementById('newsOfMonthEmpty').style.display = 'block';
            document.getElementById('newsOfMonthFilled').style.display = 'none';
        }
        // Trend Alert slot
        const trend = selectedContent.trend_alert;
        if (trend) {
            document.getElementById('trendAlertSlot').classList.add('filled');
            document.getElementById('trendAlertEmpty').style.display = 'none';
            document.getElementById('trendAlertFilled').style.display = 'block';
            document.getElementById('trendAlertTitle').textContent = trend.title;
            document.getElementById('trendAlertMeta').textContent = (trend.view_count ? formatNumber(trend.view_count) + ' views' : '');
        } else {
            document.getElementById('trendAlertSlot').classList.remove('filled');
            document.getElementById('trendAlertEmpty').style.display = 'block';
            document.getElementById('trendAlertFilled').style.display = 'none';
        }
    }

    function updateStep2NextButton() {
        document.getElementById('step2NextBtn').disabled = !(selectedContent.news_of_month && selectedContent.trend_alert);
    }

    function switchYoutubeTab(tab) {
        currentYoutubeTab = tab;
        document.getElementById('ytTabNews').classList.toggle('active', tab === 'news');
        document.getElementById('ytTabTrend').classList.toggle('active', tab === 'trend');
    }

    function sortYoutubeVideos(sort) {
        currentYoutubeSort = sort;
        document.getElementById('sortPopular').classList.toggle('active', sort === 'popular');
        document.getElementById('sortRecent').classList.toggle('active', sort === 'recent');
        loadYoutubeVideos(sort);
    }

    async function loadVideoByUrl() {
        const url = document.getElementById('youtubeUrlInput').value.trim();
        if (!url) { alert('Please enter a YouTube URL'); return; }
        try {
            const resp = await fetch(`${API_BASE}/api/youtube/video-by-url`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            const data = await resp.json();
            if (data.success && data.video) {
                selectYoutubeVideo(data.video);
                document.getElementById('youtubeUrlInput').value = '';
            } else {
                alert('Could not fetch video: ' + (data.error || 'Unknown error'));
            }
        } catch (e) { alert('Error: ' + e.message); }
    }

    // ============================================================
    // BLOG ARTICLE SELECTION
    // ============================================================
    async function loadBlogPosts(append) {
        const grid = document.getElementById('blogGrid');
        if (!append) {
            grid.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading blog posts...</p></div>';
            blogCurrentPage = 1;
        }
        try {
            const resp = await fetch(`${API_BASE}/api/blog/posts?count=15&page=${blogCurrentPage}`);
            const data = await resp.json();
            if (data.success && data.posts) {
                if (append) {
                    blogPosts = blogPosts.concat(data.posts);
                } else {
                    blogPosts = data.posts;
                }
                blogHasMore = data.has_more !== false;
                renderBlogGrid();
            } else {
                if (!append) grid.innerHTML = '<p style="color:#dc3545;text-align:center;">Failed to load blog posts.</p>';
            }
        } catch (e) {
            if (!append) grid.innerHTML = '<p style="color:#dc3545;text-align:center;">Error: ' + e.message + '</p>';
        }
    }

    function renderBlogGrid() {
        const grid = document.getElementById('blogGrid');
        grid.innerHTML = '';
        blogPosts.forEach((post, idx) => {
            const isBlog1 = selectedContent.blog_1 && selectedContent.blog_1.url === post.url;
            const isBlog2 = selectedContent.blog_2 && selectedContent.blog_2.url === post.url;
            const isSelected = isBlog1 || isBlog2;
            const card = document.createElement('div');
            card.className = 'blog-card' + (isSelected ? ' selected' : '');
            card.style.position = 'relative';
            const imgSrc = post.featured_image_url || 'https://brite.co/wp-content/uploads/2025/09/blank-image.png';
            const cats = (post.categories || []).map(c => `<span class="blog-cat">${escapeHtml(c)}</span>`).join('');
            const badge = isBlog1 ? 'ARTICLE 1' : (isBlog2 ? 'ARTICLE 2' : '');
            card.innerHTML = `
                ${badge ? `<div style="position:absolute;top:8px;right:8px;background:#018181;color:white;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700;z-index:1;">${badge}</div>` : ''}
                <a href="${post.url || '#'}" target="_blank" onclick="event.stopPropagation();" style="position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.7);color:white;padding:4px 8px;border-radius:4px;font-size:11px;text-decoration:none;z-index:2;">&#128279; View</a>
                <img class="blog-image" src="${imgSrc}" alt="${escapeHtml(post.title)}" loading="lazy">
                <div class="blog-info">
                    <div class="blog-title">${escapeHtml(post.title)}</div>
                    <div class="blog-excerpt">${escapeHtml(post.excerpt || post.meta_description || '')}</div>
                    <div class="blog-meta">
                        <span>${post.published_date || ''}</span>
                        <span>${post.published_age || ''}</span>
                    </div>
                    ${cats ? '<div class="blog-categories">' + cats + '</div>' : ''}
                </div>
            `;
            card.onclick = () => toggleBlogSelect(post);
            grid.appendChild(card);
        });
        // Add "Load More" button if there are more posts
        if (blogHasMore) {
            const loadMoreBtn = document.createElement('div');
            loadMoreBtn.style.cssText = 'text-align:center;padding:20px;grid-column:1/-1;';
            loadMoreBtn.innerHTML = '<button class="btn" onclick="blogCurrentPage++;loadBlogPosts(true)" style="background:#466F88;">Load More Articles</button>';
            grid.appendChild(loadMoreBtn);
        }
    }

    function toggleBlogSelect(post) {
        const isBlog1 = selectedContent.blog_1 && selectedContent.blog_1.url === post.url;
        const isBlog2 = selectedContent.blog_2 && selectedContent.blog_2.url === post.url;
        if (isBlog1) { selectedContent.blog_1 = null; }
        else if (isBlog2) { selectedContent.blog_2 = null; }
        else if (!selectedContent.blog_1) { selectedContent.blog_1 = post; }
        else if (!selectedContent.blog_2) { selectedContent.blog_2 = post; }
        else { alert('You can only select 2 articles. Remove one first.'); return; }
        renderBlogGrid();
        updateBlogBanner();
    }

    function updateBlogBanner() {
        const count = (selectedContent.blog_1 ? 1 : 0) + (selectedContent.blog_2 ? 1 : 0);
        document.getElementById('blogSelectedCount').textContent = count;
        document.getElementById('blogBannerStatus').textContent = count === 2 ? 'Ready!' : 'Select ' + (2 - count) + ' more';
        document.getElementById('step3NextBtn').disabled = count < 2;
    }

    // ============================================================
    // GUESS THE PRICE
    // ============================================================
    function switchGTPTab(tab) {
        currentGTPTab = tab;
        ['search', 'url', 'saved'].forEach(t => {
            document.getElementById('gtpTab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.toggle('active', t === tab);
            document.getElementById('gtp' + t.charAt(0).toUpperCase() + t.slice(1) + 'Panel').classList.toggle('active', t === tab);
        });
        if (tab === 'saved') loadSavedGTPItems();
    }

    async function searchGTP(appendResults) {
        const query = document.getElementById('gtpSearchInput').value.trim();
        const timeWindow = document.getElementById('gtpTimeWindow').value;
        if (!query) { alert('Enter a search query'); return; }
        const resultsDiv = document.getElementById('gtpSearchResults');
        if (!appendResults) {
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching...</p></div>';
            lastGTPSearchResults = [];
        } else {
            // Remove existing "Search More" button before appending
            const existingBtn = resultsDiv.querySelector('.gtp-search-more-wrap');
            if (existingBtn) existingBtn.remove();
            const loader = document.createElement('div');
            loader.className = 'loading';
            loader.innerHTML = '<div class="spinner"></div><p>Searching for more...</p>';
            resultsDiv.appendChild(loader);
        }
        try {
            const resp = await fetch(`${API_BASE}/api/guess-the-price/search`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query, time_window: timeWindow })
            });
            const data = await resp.json();
            if (data.success && data.results) {
                const startIdx = lastGTPSearchResults.length;
                lastGTPSearchResults = lastGTPSearchResults.concat(data.results);
                if (appendResults) {
                    // Remove loader
                    const loader = resultsDiv.querySelector('.loading');
                    if (loader) loader.remove();
                    // Append new cards
                    data.results.forEach((r, i) => {
                        const idx = startIdx + i;
                        const card = document.createElement('div');
                        const isCurrentlySelected = selectedContent.guess_the_price && selectedContent.guess_the_price.title === r.title;
                        card.className = 'gtp-result-card' + (isCurrentlySelected ? ' selected' : '');
                        card.style.position = 'relative';
                        const imgSrc = r.image_url || r.thumbnail || '';
                        const placeholderImg = '<div class="gtp-thumb" style="background:#f0f0f0;display:flex;align-items:center;justify-content:center;min-height:80px;border-radius:6px;color:#bbb;font-size:28px;">&#128142;</div>';
                        card.innerHTML = `${imgSrc ? '<img class="gtp-thumb" src="' + imgSrc + '" alt="" loading="lazy">' : placeholderImg}<div class="gtp-result-info"><div class="gtp-result-title">${escapeHtml(r.title || '')}</div><div class="gtp-result-publisher">${escapeHtml(r.publisher || r.source || '')}</div><div class="gtp-result-snippet">${escapeHtml(r.snippet || r.description || '')}</div></div><button class="gtp-save-btn" title="Save for later" onclick="event.stopPropagation(); saveGTPResultForLater(this, ${idx})">&#9734; Save</button>`;
                        card.onclick = () => {
                            resultsDiv.querySelectorAll('.gtp-result-card').forEach(c => c.classList.remove('selected'));
                            card.classList.add('selected');
                            selectGTPItem(r);
                        };
                        card._resultData = r;
                        resultsDiv.appendChild(card);
                    });
                } else {
                    renderGTPResults(data.results, resultsDiv);
                }
                // Add "Search More" button
                const moreWrap = document.createElement('div');
                moreWrap.className = 'gtp-search-more-wrap';
                moreWrap.style.cssText = 'text-align:center;padding:16px 0;';
                moreWrap.innerHTML = '<button class="btn btn-secondary" onclick="searchGTP(true)" style="font-size:14px;">Search More Results</button>';
                resultsDiv.appendChild(moreWrap);
            } else {
                if (appendResults) {
                    const loader = resultsDiv.querySelector('.loading');
                    if (loader) loader.remove();
                }
                resultsDiv.innerHTML += '<p style="color:#dc3545;">Search failed: ' + (data.error || 'Unknown error') + '</p>';
            }
        } catch (e) {
            resultsDiv.innerHTML = '<p style="color:#dc3545;">Error: ' + e.message + '</p>';
        }
    }

    function renderGTPResults(results, container, isSavedTab) {
        if (!results.length) { container.innerHTML = '<p style="color:#999;text-align:center;">No results found. Try a different search.</p>'; return; }
        container.innerHTML = '';
        results.forEach((r, idx) => {
            const card = document.createElement('div');
            const isCurrentlySelected = selectedContent.guess_the_price && selectedContent.guess_the_price.title === r.title;
            card.className = 'gtp-result-card' + (isCurrentlySelected ? ' selected' : '');
            card.style.position = 'relative';
            const imgSrc = r.image_url || r.thumbnail || '';
            const placeholderImg = '<div class="gtp-thumb" style="background:#f0f0f0;display:flex;align-items:center;justify-content:center;min-height:80px;border-radius:6px;color:#bbb;font-size:28px;">&#128142;</div>';
            card.innerHTML = `
                ${imgSrc ? '<img class="gtp-thumb" src="' + imgSrc + '" alt="" loading="lazy" onerror="this.outerHTML=\'' + placeholderImg.replace(/'/g, "\\'") + '\'">' : placeholderImg}
                <div class="gtp-result-info">
                    <div class="gtp-result-title">${escapeHtml(r.title || '')}</div>
                    <div class="gtp-result-publisher">${escapeHtml(r.publisher || r.source || '')}</div>
                    <div class="gtp-result-snippet">${escapeHtml(r.snippet || r.description || '')}</div>
                </div>
                ${!isSavedTab ? '<button class="gtp-save-btn" title="Save for later" onclick="event.stopPropagation(); saveGTPResultForLater(this, ' + idx + ')">&#9734; Save</button>' : '<button class="gtp-delete-btn" title="Delete saved item" onclick="event.stopPropagation(); deleteGTPSavedItem(this, \'' + encodeURIComponent(r.url || '') + '\')">&#10005;</button>'}
            `;
            card.onclick = () => {
                container.querySelectorAll('.gtp-result-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectGTPItem(r);
            };
            card._resultData = r;
            container.appendChild(card);
        });
    }

    let lastGTPSearchResults = [];

    async function saveGTPResultForLater(btn, idx) {
        const item = lastGTPSearchResults[idx];
        if (!item) return;
        btn.disabled = true;
        btn.innerHTML = '...';
        try {
            await fetch(`${API_BASE}/api/saved-articles`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ article: { url: item.url, title: item.title, description: item.snippet || item.description || '', image: item.image_url || item.thumbnail || '' } })
            });
            btn.innerHTML = '&#9733; Saved';
            btn.style.color = '#059669';
            btn.style.borderColor = '#059669';
        } catch (e) {
            btn.innerHTML = 'Error';
            btn.style.color = '#dc3545';
            setTimeout(() => { btn.innerHTML = '&#9734; Save'; btn.style.color = ''; btn.style.borderColor = ''; btn.disabled = false; }, 2000);
        }
    }

    async function deleteGTPSavedItem(btn, encodedUrl) {
        const url = decodeURIComponent(encodedUrl);
        if (!confirm('Delete this saved item?')) return;
        btn.disabled = true;
        try {
            await fetch(`${API_BASE}/api/saved-articles`, {
                method: 'DELETE', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            const card = btn.closest('.gtp-result-card');
            if (card) card.remove();
            const container = document.getElementById('gtpSavedItems');
            if (!container.querySelector('.gtp-result-card')) {
                container.innerHTML = '<p style="color:#999;text-align:center;">No saved items yet.</p>';
            }
        } catch (e) { alert('Delete failed: ' + e.message); btn.disabled = false; }
    }

    async function fetchGTPUrl() {
        const url = document.getElementById('gtpUrlInput').value.trim();
        if (!url) { alert('Enter a URL'); return; }
        const resultDiv = document.getElementById('gtpUrlResult');
        resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Fetching metadata...</p></div>';
        try {
            const resp = await fetch(`${API_BASE}/api/fetch-article-metadata`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            const data = await resp.json();
            if (data.success) {
                const m = data.metadata || data;
                selectGTPItem({ title: m.title || '', url: url, snippet: m.description || '', image_url: m.image || '' });
                resultDiv.innerHTML = '<p style="color:#059669;">Item loaded! See details below.</p>';
            } else {
                resultDiv.innerHTML = '<p style="color:#dc3545;">Could not fetch: ' + (data.error || '') + '</p>';
            }
        } catch (e) {
            resultDiv.innerHTML = '<p style="color:#dc3545;">Error: ' + e.message + '</p>';
        }
    }

    async function loadSavedGTPItems() {
        const container = document.getElementById('gtpSavedItems');
        container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading saved items...</p></div>';
        try {
            const resp = await fetch(`${API_BASE}/api/saved-articles`);
            const data = await resp.json();
            if (data.success && data.articles && data.articles.length) {
                renderGTPResults(data.articles.map(a => ({
                    title: a.title, url: a.url, snippet: a.description, image_url: a.image
                })), container, true);
            } else {
                container.innerHTML = '<p style="color:#999;text-align:center;">No saved items yet.</p>';
            }
        } catch (e) {
            container.innerHTML = '<p style="color:#dc3545;">Error: ' + e.message + '</p>';
        }
    }

    async function selectGTPItem(item) {
        // Show details form
        document.getElementById('gtpDetailsForm').style.display = 'block';
        document.getElementById('gtpTitle').value = item.title || '';
        document.getElementById('gtpImageUrl').value = item.image_url || item.image || '';
        document.getElementById('gtpSourceLink').value = item.url || '';
        document.getElementById('gtpMaterial').value = '';
        document.getElementById('gtpFoundIn').value = '';
        document.getElementById('gtpWhereItLives').value = '';
        document.getElementById('gtpFunFact').value = '';
        previewGTPImage();

        // Auto-fetch OG image if no image provided and URL exists
        if (!(item.image_url || item.image) && item.url) {
            let statusEl = document.getElementById('gtpImageStatus');
            if (!statusEl) {
                const preview = document.getElementById('gtpImagePreview');
                statusEl = document.createElement('p');
                statusEl.id = 'gtpImageStatus';
                statusEl.style.cssText = 'font-size:13px;color:#666;margin:4px 0 0 0;';
                preview.parentNode.insertBefore(statusEl, preview.nextSibling);
            }
            statusEl.innerHTML = '<span style="color:#2563eb;">Searching for image from URL...</span>';
            try {
                const imgResp = await fetch(`${API_BASE}/api/fetch-article-metadata`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: item.url })
                });
                const imgData = await imgResp.json();
                if (imgData.success && imgData.metadata?.image) {
                    document.getElementById('gtpImageUrl').value = imgData.metadata.image;
                    previewGTPImage();
                } else {
                    statusEl.innerHTML = '<span style="color:#b45309;">No image found automatically. Paste an image URL above or upload one in step 8.</span>';
                }
            } catch (e) {
                console.log('Auto image fetch failed:', e);
                statusEl.innerHTML = '<span style="color:#b45309;">Could not fetch image. Paste an image URL above or upload one in step 8.</span>';
            }
        }

        // Auto-generate details with AI
        document.getElementById('gtpGeneratingDetails').style.display = 'block';
        document.getElementById('gtpDetailFields').style.opacity = '0.5';
        document.getElementById('gtpAIBadge').style.display = 'none';
        try {
            const resp = await fetch(`${API_BASE}/api/guess-the-price/generate-details`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: item.title || '', url: item.url || '', snippet: item.snippet || item.description || '' })
            });
            const data = await resp.json();
            if (data.success && data.details) {
                const d = data.details;
                document.getElementById('gtpMaterial').value = d.material || '';
                document.getElementById('gtpFoundIn').value = d.found_in || '';
                document.getElementById('gtpWhereItLives').value = d.where_it_lives || '';
                document.getElementById('gtpFunFact').value = d.fun_fact || '';
                document.getElementById('gtpAIBadge').style.display = 'inline';
            }
        } catch (e) { console.error('GTP detail gen error:', e); }
        document.getElementById('gtpGeneratingDetails').style.display = 'none';
        document.getElementById('gtpDetailFields').style.opacity = '1';

        updateGTPSelection();
        document.getElementById('gtpDetailsForm').scrollIntoView({ behavior: 'smooth' });
    }

    function updateGTPSelection() {
        selectedContent.guess_the_price = {
            title: document.getElementById('gtpTitle').value,
            image_url: document.getElementById('gtpImageUrl').value,
            material: document.getElementById('gtpMaterial').value,
            found_in: document.getElementById('gtpFoundIn').value,
            where_it_lives: document.getElementById('gtpWhereItLives').value,
            fun_fact: document.getElementById('gtpFunFact').value,
            source_link: document.getElementById('gtpSourceLink').value
        };
        document.getElementById('step4NextBtn').disabled = !selectedContent.guess_the_price.title;
    }

    // Listen for changes on GTP detail fields
    ['gtpTitle','gtpImageUrl','gtpMaterial','gtpFoundIn','gtpWhereItLives','gtpFunFact','gtpSourceLink'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateGTPSelection);
    });

    function previewGTPImage() {
        const url = document.getElementById('gtpImageUrl').value.trim();
        const preview = document.getElementById('gtpImagePreview');
        const overlay = document.getElementById('gtpImageClearOverlay');
        let statusEl = document.getElementById('gtpImageStatus');
        if (!statusEl) {
            statusEl = document.createElement('p');
            statusEl.id = 'gtpImageStatus';
            statusEl.style.cssText = 'font-size:13px;color:#666;margin:4px 0 0 0;';
            document.getElementById('gtpImagePreviewWrap').parentNode.insertBefore(statusEl, document.getElementById('gtpImagePreviewWrap').nextSibling);
        }
        if (url) {
            preview.style.display = 'block';
            preview.src = url;
            preview.alt = '';
            preview.onerror = function() {
                preview.style.display = 'none';
                if (overlay) overlay.style.display = 'none';
                statusEl.innerHTML = '<span style="color:#b45309;">Preview blocked by source site (CORS). The image URL will still work in the sent email. <a href="' + url + '" target="_blank" style="color:#2563eb;">Open image to verify &rarr;</a></span>';
            };
            preview.onload = function() {
                statusEl.textContent = '';
                if (overlay) overlay.style.display = 'block';
                const cropBtn = document.getElementById('gtpCropBtn');
                if (cropBtn) cropBtn.style.display = 'inline-block';
            };
            statusEl.textContent = '';
        } else {
            preview.style.display = 'none';
            if (overlay) overlay.style.display = 'none';
            statusEl.textContent = '';
        }
    }

    function clearGTPImage() {
        document.getElementById('gtpImageUrl').value = '';
        document.getElementById('gtpImagePreview').style.display = 'none';
        const overlay = document.getElementById('gtpImageClearOverlay');
        if (overlay) overlay.style.display = 'none';
        const cropBtn = document.getElementById('gtpCropBtn');
        if (cropBtn) cropBtn.style.display = 'none';
        const statusEl = document.getElementById('gtpImageStatus');
        if (statusEl) statusEl.textContent = '';
        document.getElementById('gtpFileUpload').value = '';
        // Clear from selected content
        if (selectedContent.guess_the_price) {
            selectedContent.guess_the_price.image_url = '';
        }
    }

    // ---- Cropper.js for GTP image ----
    let gtpCropper = null;
    let gtpCropSourceUrl = '';
    let gtpCropOrigin = 'step4'; // 'step4' or 'step8'

    function handleGTPFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            gtpCropSourceUrl = e.target.result;
            gtpCropOrigin = 'step4';
            openGTPCropper();
        };
        reader.readAsDataURL(file);
    }

    function openGTPCropper() {
        if (!gtpCropSourceUrl) {
            const url = document.getElementById('gtpImageUrl').value.trim();
            if (!url) { alert('Enter an image URL or upload a file first'); return; }
            gtpCropSourceUrl = url;
        }
        const modal = document.getElementById('cropModal');
        const cropImg = document.getElementById('cropImage');
        // Set crossOrigin for URL-based images to allow canvas export
        if (gtpCropSourceUrl.startsWith('http')) {
            cropImg.crossOrigin = 'anonymous';
        } else {
            cropImg.removeAttribute('crossOrigin');
        }
        cropImg.src = gtpCropSourceUrl;
        modal.classList.add('active');
        cropImg.onload = function() {
            if (gtpCropper) { gtpCropper.destroy(); }
            gtpCropper = new Cropper(cropImg, {
                aspectRatio: 16 / 9,
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 1,
                restore: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
                checkCrossOrigin: true,
                checkOrientation: false,
            });
        };
    }

    function closeCropModal() {
        document.getElementById('cropModal').classList.remove('active');
        if (gtpCropper) { gtpCropper.destroy(); gtpCropper = null; }
        gtpCropSourceUrl = '';
        document.getElementById('gtpFileUpload').value = '';
    }

    async function applyCrop() {
        if (!gtpCropper) return;
        let dataUrl;
        try {
            const canvas = gtpCropper.getCroppedCanvas({
                maxWidth: 1200,
                maxHeight: 800,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high',
            });
            dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        } catch (e) {
            alert('This image cannot be cropped due to security restrictions. Please use "Upload Image" to upload the file from your computer instead.');
            closeCropModal();
            return;
        }
        const origin = gtpCropOrigin;
        closeCropModal();

        if (origin === 'step8') {
            // Step 8: store in generatedImages and show in image result
            generatedImages.guess_the_price = { url: dataUrl, prompt: 'uploaded-cropped' };
            showImageResult('guess_the_price', dataUrl);
            // Also update selectedContent so preview uses this image
            if (selectedContent.guess_the_price) {
                selectedContent.guess_the_price.image_url = dataUrl;
            }
            console.log('[Crop] Applied for Step 8 GTP image');
        } else {
            // Step 4: show in preview area and update URL field
            const preview = document.getElementById('gtpImagePreview');
            const overlay = document.getElementById('gtpImageClearOverlay');
            const cropBtn = document.getElementById('gtpCropBtn');
            preview.src = dataUrl;
            preview.style.display = 'block';
            if (overlay) overlay.style.display = 'block';
            if (cropBtn) cropBtn.style.display = 'inline-block';

            // Upload cropped image to GCS
            try {
                const response = await fetch(`${API_BASE}/api/upload-images-to-gcs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        images: { 'gtp-cropped': dataUrl },
                        month: selectedMonth || 'unknown',
                        year: selectedYear || new Date().getFullYear()
                    })
                });
                const result = await response.json();
                if (result.success && result.urls['gtp-cropped']) {
                    document.getElementById('gtpImageUrl').value = result.urls['gtp-cropped'];
                    preview.src = result.urls['gtp-cropped'];
                    updateGTPSelection();
                    console.log('[Crop] Uploaded to GCS:', result.urls['gtp-cropped']);
                } else {
                    document.getElementById('gtpImageUrl').value = dataUrl;
                    updateGTPSelection();
                }
            } catch (e) {
                console.error('[Crop] GCS upload failed, using data URL:', e);
                document.getElementById('gtpImageUrl').value = dataUrl;
                updateGTPSelection();
            }
        }
    }

    function populateImageReview() {
        const qtDiv = document.getElementById('reviewQuickTipImage');
        const gtpDiv = document.getElementById('reviewGTPImage');
        const qtImg = generatedImages.quick_tip ? (generatedImages.quick_tip.url || generatedImages.quick_tip) : '';
        const gtpImg = generatedImages.guess_the_price ? (generatedImages.guess_the_price.url || generatedImages.guess_the_price) : (selectedContent.guess_the_price?.image_url || '');
        qtDiv.innerHTML = qtImg ? `<img src="${qtImg}" style="max-width:100%;max-height:300px;border-radius:8px;display:block;">` : '<p style="color:#999;">No image generated</p>';
        gtpDiv.innerHTML = gtpImg ? `<img src="${gtpImg}" style="max-width:100%;max-height:300px;border-radius:8px;display:block;">` : '<p style="color:#999;">No image generated</p>';
    }

    function openGTPCropperFromReview() {
        const gtpImg = generatedImages.guess_the_price ? (generatedImages.guess_the_price.url || generatedImages.guess_the_price) : (selectedContent.guess_the_price?.image_url || '');
        if (!gtpImg) { alert('No GTP image to crop'); return; }
        gtpCropSourceUrl = gtpImg;
        gtpCropOrigin = 'step8';
        openGTPCropper();
    }

    async function saveGTPItem() {
        const item = selectedContent.guess_the_price;
        if (!item || !item.title) { alert('No item selected'); return; }
        try {
            await fetch(`${API_BASE}/api/saved-articles`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ article: { url: item.source_link, title: item.title, description: item.fun_fact, image: item.image_url } })
            });
            alert('Item saved for later!');
        } catch (e) { alert('Save failed: ' + e.message); }
    }

    async function regenerateGTPDetails() {
        const title = document.getElementById('gtpTitle').value;
        const url = document.getElementById('gtpSourceLink').value;
        if (!title) { alert('Enter a title first'); return; }
        await selectGTPItem({ title, url, snippet: '', image_url: document.getElementById('gtpImageUrl').value });
    }

    // ============================================================
    // INTRO & QUICK TIP
    // ============================================================
    async function aiRewriteIntro() {
        const textarea = document.getElementById('introContent');
        const content = textarea.value.trim();
        if (!content) { alert('Write some intro text first, then click AI Rewrite'); return; }
        const btn = event.target;
        btn.disabled = true; btn.textContent = 'Rewriting...';
        try {
            const resp = await fetch(`${API_BASE}/api/rewrite-content`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, tone: 'friendly', section: 'intro' })
            });
            const data = await resp.json();
            if (data.success && data.rewritten) textarea.value = data.rewritten;
            else alert('Rewrite failed: ' + (data.error || 'Unknown error'));
        } catch (e) { alert('Error: ' + e.message); }
        btn.disabled = false; btn.textContent = 'AI Rewrite';
        updateWordCount('introContent', 'introWordCount');
    }

    async function generateQuickTip() {
        const btn = event.target;
        btn.disabled = true; btn.textContent = 'Generating...';
        try {
            const resp = await fetch(`${API_BASE}/api/generate-quick-tip`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ month: selectedMonth || 'january' })
            });
            const data = await resp.json();
            if (data.success) {
                document.getElementById('quickTipContent').value = data.tip || '';
                if (data.image_prompt) {
                    const promptEl = document.getElementById('quickTipImagePrompt');
                    if (promptEl) promptEl.value = data.image_prompt;
                }
            } else { alert('Generation failed: ' + (data.error || '')); }
        } catch (e) { alert('Error: ' + e.message); }
        btn.disabled = false; btn.textContent = 'AI Generate';
        updateWordCount('quickTipContent', 'quickTipWordCount');
    }

    // ============================================================
    // HELPERS
    // ============================================================
    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function stripMarkdown(text) {
        if (!text) return '';
        return text
            .replace(/<\/?[^>]+(>|$)/g, '')  // Strip HTML tags
            .replace(/\*\*(.*?)\*\*/g, '$1')  // **bold**  bold
            .replace(/\*(.*?)\*/g, '$1')       // *italic*  italic
            .replace(/__(.*?)__/g, '$1')       // __bold__  bold
            .replace(/_(.*?)_/g, '$1')         // _italic_  italic
            .replace(/#{1,6}\s/g, '')          // ### headers  remove
            .replace(/\n/g, ' ')               // newlines  spaces
            .replace(/\s+/g, ' ')              // collapse whitespace
            .trim();
    }

    function markdownToHtml(text) {
        if (!text) return '';
        return text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/__(.*?)__/g, '<strong>$1</strong>')
            .replace(/_(.*?)_/g, '<em>$1</em>')
            .replace(/<\/?p>/gi, '')           // Remove <p> wrappers from AI
            .replace(/<br\s*\/?>/gi, ' ')      // Replace <br> with space
            .trim();
    }

    function formatNumber(num) {
        if (!num) return '0';
        num = parseInt(num);
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }

    function formatRelativeDate(dateStr) {
        try {
            const d = new Date(dateStr);
            const now = new Date();
            const days = Math.floor((now - d) / 86400000);
            if (days === 0) return 'Today';
            if (days === 1) return '1 day ago';
            if (days < 7) return days + ' days ago';
            if (days < 30) return Math.floor(days/7) + ' weeks ago';
            if (days < 365) return Math.floor(days/30) + ' months ago';
            return Math.floor(days/365) + ' years ago';
        } catch (e) { return dateStr; }
    }

    function updateWordCount(textareaId, countId) {
        const text = document.getElementById(textareaId)?.value || '';
        const words = text.trim() ? text.trim().split(/\s+/).length : 0;
        const el = document.getElementById(countId);
        if (el) el.textContent = words + ' words';
    }

    function setupWordCounters() {
        [['introContent','introWordCount'],['quickTipContent','quickTipWordCount']].forEach(([tid,cid]) => {
            const el = document.getElementById(tid);
            if (el) {
                el.addEventListener('input', () => updateWordCount(tid, cid));
                updateWordCount(tid, cid);
            }
        });
    }

    function showSaveConfirm(btn) {
        const orig = btn.textContent;
        btn.textContent = 'Saved!';
        btn.style.background = '#22c55e';
        setTimeout(() => { btn.textContent = orig; btn.style.background = '#059669'; }, 2000);
    }

    // ============================================================
    // CONTENT GENERATION
    // ============================================================
    async function generateContent() {
        // Validate selections
        if (!selectedContent.news_of_month) { alert('Please select a News of the Month video (Step 2)'); return; }
        if (!selectedContent.trend_alert) { alert('Please select a Trend Alert video (Step 2)'); return; }
        if (!selectedContent.blog_1 || !selectedContent.blog_2) { alert('Please select 2 blog articles (Step 3)'); return; }
        if (!selectedContent.guess_the_price) { alert('Please select a Guess the Price item (Step 4)'); return; }

        goToStep(6);
        const setStatus = (id, text, cls) => {
            const el = document.getElementById(id);
            el.textContent = text;
            el.className = 'gen-status ' + (cls || '');
        };

        setStatus('genIntroStatus', 'Intro & Agenda: Generating...', 'active');
        setStatus('genNewsStatus', 'News of the Month: Waiting...', '');
        setStatus('genTrendStatus', 'Trend Alert: Waiting...', '');
        setStatus('genGTPStatus', 'Guess the Price: Waiting...', '');
        setStatus('genTipStatus', 'Quick Tip: Waiting...', '');

        try {
            const intro = document.getElementById('introContent')?.value || '';
            const quickTip = document.getElementById('quickTipContent')?.value || '';
            const gtp = selectedContent.guess_the_price;

            const resp = await fetch(`${API_BASE}/api/generate-newsletter`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    month: selectedMonth,
                    intro: intro,
                    news_of_month: {
                        title: selectedContent.news_of_month.title,
                        description: selectedContent.news_of_month.description || '',
                        thumbnail_url: selectedContent.news_of_month.thumbnail_url || '',
                        url: selectedContent.news_of_month.url || ''
                    },
                    trend_alert: {
                        title: selectedContent.trend_alert.title,
                        description: selectedContent.trend_alert.description || '',
                        thumbnail_url: selectedContent.trend_alert.thumbnail_url || '',
                        url: selectedContent.trend_alert.url || ''
                    },
                    blog_articles: [
                        { title: selectedContent.blog_1.title, url: selectedContent.blog_1.url, featured_image_url: selectedContent.blog_1.featured_image_url || '', excerpt: selectedContent.blog_1.excerpt || '' },
                        { title: selectedContent.blog_2.title, url: selectedContent.blog_2.url, featured_image_url: selectedContent.blog_2.featured_image_url || '', excerpt: selectedContent.blog_2.excerpt || '' }
                    ],
                    guess_the_price: { title: gtp.title, material: gtp.material, fun_fact: gtp.fun_fact },
                    quick_tip: quickTip
                })
            });

            const data = await resp.json();
            if (data.success && data.generated) {
                generatedContent = data.generated;
                setStatus('genIntroStatus', 'Intro & Agenda: Done', 'done');
                setStatus('genNewsStatus', 'News of the Month: Done', 'done');
                setStatus('genTrendStatus', 'Trend Alert: Done', 'done');
                setStatus('genGTPStatus', 'Guess the Price: Done', 'done');
                setStatus('genTipStatus', 'Quick Tip: Done', 'done');
                await new Promise(r => setTimeout(r, 500));
                populateReviewContent();
                showStep('6b');
            } else {
                alert('Error generating content: ' + (data.error || 'Unknown error'));
                goToStep(5);
            }
        } catch (e) {
            alert('Error: ' + e.message);
            goToStep(5);
        }
    }

    function populateReviewContent() {
        const gc = generatedContent;
        // Convert markdown to HTML for contenteditable divs
        const setContent = (id, text) => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = markdownToHtml(text || '');
        };

        setContent('fc-intro', gc.intro || '');

        // Agenda items
        if (gc.agenda_items && gc.agenda_items.length) {
            const agendaEl = document.getElementById('fc-agenda');
            if (agendaEl) agendaEl.innerHTML = '<ul>' + gc.agenda_items.map(i => '<li>' + markdownToHtml(i) + '</li>').join('') + '</ul>';
        }

        // Video descriptions
        setContent('fc-news', gc.news_of_month?.description || '');
        setContent('fc-trend', gc.trend_alert?.description || '');

        // GTP question
        setContent('fc-gtp', gc.guess_the_price?.question || '');

        // Quick tip
        setContent('fc-tip', gc.quick_tip || '');
    }

    async function aiRewriteSection(section) {
        const sectionMap = {
            'news_of_month': 'fc-news',
            'trend_alert': 'fc-trend',
            'guess_the_price': 'fc-gtp',
            'quick_tip': 'fc-tip'
        };
        const elId = sectionMap[section];
        if (!elId) return;
        const el = document.getElementById(elId);
        const content = el.textContent || el.innerText;
        if (!content.trim()) { alert('No content to rewrite'); return; }
        el.style.opacity = '0.5';
        try {
            const resp = await fetch(`${API_BASE}/api/rewrite-content`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, tone: 'friendly', section })
            });
            const data = await resp.json();
            if (data.success && data.rewritten) el.innerHTML = data.rewritten;
        } catch (e) { console.error('Rewrite error:', e); }
        el.style.opacity = '1';
    }

    // ============================================================
    // BRAND CHECK + EXPORT
    // ============================================================
    async function runBrandCheck() {
        // Show step 7 loading screen directly (NOT via goToStep to avoid infinite recursion)
        currentStep = 7;
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step7').classList.add('active');
        updateProgressBar();
        window.scrollTo(0, 0);

        try {
            const contentForCheck = buildContentObject();
            const resp = await fetch(`${API_BASE}/api/check-brand-guidelines`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: contentForCheck, month: selectedMonth })
            });
            const data = await resp.json();
            if (data.success) {
                renderBrandCheckResults(data.brand_check);
            } else {
                document.getElementById('brandCheckResults').innerHTML =
                    '<div class="brand-suggestion brand-pass"><p>Brand check could not run: ' + (data.error || 'Unknown error') + '</p></div>';
            }
        } catch (e) {
            document.getElementById('brandCheckResults').innerHTML =
                '<div class="brand-suggestion brand-pass"><p>Brand check error: ' + e.message + '</p></div>';
        }
        showStep('7b');
    }

    function getEditableContent(id) {
        const el = document.getElementById(id);
        return el ? el.innerHTML : '';
    }

    function getEditableText(id) {
        const el = document.getElementById(id);
        return el ? (el.textContent || el.innerText) : '';
    }

    function buildContentObject() {
        return {
            intro: getEditableText('fc-intro') || generatedContent.intro || '',
            agenda_items: generatedContent.agenda_items || [],
            news_of_month: {
                title: selectedContent.news_of_month?.title || '',
                description: getEditableText('fc-news') || generatedContent.news_of_month?.description || '',
                thumbnail_url: selectedContent.news_of_month?.thumbnail_url || generatedContent.news_of_month?.thumbnail_url || '',
                video_url: selectedContent.news_of_month?.url || generatedContent.news_of_month?.video_url || ''
            },
            trend_alert: {
                title: selectedContent.trend_alert?.title || '',
                description: getEditableText('fc-trend') || generatedContent.trend_alert?.description || '',
                thumbnail_url: selectedContent.trend_alert?.thumbnail_url || generatedContent.trend_alert?.thumbnail_url || '',
                video_url: selectedContent.trend_alert?.url || generatedContent.trend_alert?.video_url || ''
            },
            blog_articles: [
                { title: selectedContent.blog_1?.title || '', featured_image_url: selectedContent.blog_1?.featured_image_url || '', url: selectedContent.blog_1?.url || '' },
                { title: selectedContent.blog_2?.title || '', featured_image_url: selectedContent.blog_2?.featured_image_url || '', url: selectedContent.blog_2?.url || '' }
            ],
            guess_the_price: {
                title: selectedContent.guess_the_price?.title || '',
                image_url: selectedContent.guess_the_price?.image_url || (generatedImages.guess_the_price?.url || ''),
                material: selectedContent.guess_the_price?.material || '',
                found_in: selectedContent.guess_the_price?.found_in || '',
                where_it_lives: selectedContent.guess_the_price?.where_it_lives || '',
                fun_fact: selectedContent.guess_the_price?.fun_fact || '',
                question: getEditableText('fc-gtp') || generatedContent.guess_the_price?.question || '',
                link: selectedContent.guess_the_price?.source_link || ''
            },
            quick_tip: getEditableText('fc-tip') || generatedContent.quick_tip || ''
        };
    }

    function renderBrandCheckResults(check) {
        const container = document.getElementById('brandCheckResults');
        if (!check) { container.innerHTML = '<div class="brand-suggestion brand-pass"><p>No issues found!</p></div>'; return; }

        const suggestions = check.suggestions || check.issues || [];
        let html = '';

        if (suggestions.length === 0) {
            html += '<div style="text-align: center; padding: 40px; background: #10b98120; border-radius: 8px; margin-bottom: 20px;">';
            html += '<h2 style="margin: 0; color: #10b981; font-size: 32px;">Looks Great!</h2>';
            html += '<p style="margin: 10px 0 0 0; color: #666;">No brand guideline issues found. Your content is ready to go!</p>';
            html += '</div>';
        } else {
            html += '<div style="text-align: center; padding: 20px; background: #fef3c7; border-radius: 8px; margin-bottom: 20px;">';
            html += '<h2 style="margin: 0; color: #f59e0b; font-size: 28px;">Suggested Changes</h2>';
            html += '<p style="margin: 10px 0 0 0; color: #666;">Yellow highlights show what needs changing. Green highlights show suggested replacements.</p>';
            html += '</div>';
        }

        // Get the full content from each section and apply highlights
        const introContent = highlightContent(
            document.getElementById('fc-intro')?.innerHTML || '',
            suggestions.filter(s => s.section === 'intro' || s.section === 'introduction')
        );
        const newsContent = highlightContent(
            document.getElementById('fc-news')?.innerHTML || '',
            suggestions.filter(s => s.section === 'news_of_month' || s.section === 'news')
        );
        const trendContent = highlightContent(
            document.getElementById('fc-trend')?.innerHTML || '',
            suggestions.filter(s => s.section === 'trend_alert' || s.section === 'trend')
        );
        const gtpContent = highlightContent(
            document.getElementById('fc-gtp')?.innerHTML || '',
            suggestions.filter(s => s.section === 'guess_the_price' || s.section === 'gtp')
        );
        const tipContent = highlightContent(
            document.getElementById('fc-tip')?.innerHTML || '',
            suggestions.filter(s => s.section === 'quick_tip' || s.section === 'tip')
        );

        // Display each section with highlighted content
        const sections = [
            { label: 'Introduction', content: introContent },
            { label: 'News of the Month', content: newsContent },
            { label: 'Trend Alert', content: trendContent },
            { label: 'Guess the Price', content: gtpContent },
            { label: 'Quick Tip', content: tipContent }
        ];

        sections.forEach(s => {
            html += '<h3 style="margin: 25px 0 10px 0; color: #272d3f;">' + s.label + '</h3>';
            html += '<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #e5e7eb; font-size: 15px; line-height: 1.6; color: #333;">';
            html += s.content || '<p style="color: #999;">No content</p>';
            html += '</div>';
        });

        // Legend
        if (suggestions.length > 0) {
            html += '<div style="margin-top: 25px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 2px dashed #e5e7eb;">';
            html += '<h4 style="margin: 0 0 10px 0; color: #666;">Legend:</h4>';
            html += '<div style="display: flex; gap: 20px; flex-wrap: wrap;">';
            html += '<div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 4px;"></div><span style="font-size: 14px; color: #666;">Current text (needs changing)</span></div>';
            html += '<div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 20px; background: #d1fae5; border: 2px solid #10b981; border-radius: 4px;"></div><span style="font-size: 14px; color: #666;">Suggested replacement</span></div>';
            html += '</div>';
            html += '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">';
            html += '<strong style="color: #f59e0b;">' + suggestions.length + ' issue' + (suggestions.length === 1 ? '' : 's') + ' found</strong> - Click Accept or Ignore on each highlighted change.';
            html += '</div></div>';
        }

        container.innerHTML = html;
    }

    function highlightContent(content, suggestions) {
        if (!suggestions || suggestions.length === 0) return content;
        let highlighted = content;
        suggestions.forEach((suggestion, index) => {
            const original = suggestion.original || suggestion.issue || '';
            const suggested = suggestion.suggested || suggestion.suggestion || '';
            const reason = suggestion.reason || '';
            const section = suggestion.section || '';
            if (!original) return;
            const suggestionId = 'suggestion-' + section + '-' + index;
            const highlightedText = '<span id="' + suggestionId + '" style="position: relative; display: inline; margin: 4px 0;">'
                + '<span style="background: #fef3c7; border-bottom: 3px solid #f59e0b; padding: 2px 4px; text-decoration: line-through;" title="' + escapeForAttribute(reason) + '">' + original + '</span>'
                + '<span style="background: #d1fae5; border-bottom: 3px solid #10b981; padding: 2px 4px; margin-left: 4px; font-weight: 600;" title="' + escapeForAttribute(reason) + '">' + suggested + '</span>'
                + '<span style="display: inline-block; margin-left: 8px;">'
                + '<button onclick="acceptSuggestion(\'' + suggestionId + '\', \'' + escapeForAttribute(original) + '\', \'' + escapeForAttribute(suggested) + '\', \'' + section + '\')" style="background: #10b981; color: white; border: none; padding: 2px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-right: 4px;" title="Accept this change">Accept</button>'
                + '<button onclick="ignoreSuggestion(\'' + suggestionId + '\')" style="background: #ef4444; color: white; border: none; padding: 2px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;" title="Ignore this suggestion">Ignore</button>'
                + '</span></span>';
            const regex = new RegExp(escapeRegExp(original), 'gi');
            highlighted = highlighted.replace(regex, highlightedText);
        });
        return highlighted;
    }

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function escapeForAttribute(string) {
        if (!string) return '';
        return string.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    function acceptSuggestion(suggestionId, original, suggested, section) {
        const sectionToContentBox = {
            'intro': 'fc-intro', 'introduction': 'fc-intro',
            'news_of_month': 'fc-news', 'news': 'fc-news',
            'trend_alert': 'fc-trend', 'trend': 'fc-trend',
            'guess_the_price': 'fc-gtp', 'gtp': 'fc-gtp',
            'quick_tip': 'fc-tip', 'tip': 'fc-tip'
        };
        const contentBoxId = sectionToContentBox[section];
        if (contentBoxId) {
            const contentBox = document.getElementById(contentBoxId);
            if (contentBox) {
                contentBox.innerHTML = contentBox.innerHTML.replace(
                    new RegExp(escapeRegExp(original), 'gi'), suggested
                );
            }
        }
        const suggestionEl = document.getElementById(suggestionId);
        if (suggestionEl) {
            suggestionEl.outerHTML = '<span style="background: #d1fae5; padding: 2px 4px; border-radius: 4px;">' + suggested + '</span>';
        }
    }

    function ignoreSuggestion(suggestionId) {
        const suggestionEl = document.getElementById(suggestionId);
        if (suggestionEl) {
            const originalSpan = suggestionEl.querySelector('span:first-child');
            const originalText = originalSpan ? originalSpan.textContent : '';
            suggestionEl.outerHTML = originalText;
        }
    }

    async function exportToDocs() {
        const btn = document.getElementById('exportBtn');
        const btnText = document.getElementById('exportBtnText');
        const resultDiv = document.getElementById('exportDocsResult');
        btn.disabled = true; btnText.textContent = 'Exporting...';
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#f0f9ff';
        resultDiv.style.border = '2px solid #3b82f6';
        resultDiv.innerHTML = '<p style="margin:0;color:#1e40af;">Creating Google Doc... this may take a moment.</p>';
        try {
            const content = buildContentObject();
            const year = new Date().getFullYear();
            const monthCapitalized = selectedMonth.charAt(0).toUpperCase() + selectedMonth.slice(1);
            const resp = await fetch(`${API_BASE}/api/export-to-docs`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content, month: selectedMonth, year,
                    title: `${year} ${monthCapitalized} - Consumer Newsletter`,
                    send_email: false
                })
            });
            const data = await resp.json();
            btn.disabled = false;
            btnText.textContent = 'Export to Google Docs';
            if (data.success && data.doc_url) {
                exportedDocUrl = data.doc_url;
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#d1fae5';
                resultDiv.style.border = '2px solid #10b981';
                resultDiv.innerHTML = `
                    <p style="margin: 0 0 10px 0; color: #065f46; font-weight: 600;">Export Successful!</p>
                    <p style="margin: 0; font-size: 14px;">
                        <a href="${data.doc_url}" target="_blank" style="color: #047857; text-decoration: underline;">Open in Google Docs</a>
                    </p>
                `;
                document.getElementById('docsLinkContainer').style.display = 'block';
                document.getElementById('docsLink').href = data.doc_url;

                // Show email section and populate recipients
                document.getElementById('emailAfterExportSection').style.display = 'block';
                const recipientList = document.getElementById('recipientList');
                recipientList.innerHTML = '';
                TEAM_MEMBERS.forEach((m, i) => {
                    recipientList.innerHTML += `<label style="display:flex;align-items:center;gap:8px;padding:6px 0;font-size:14px;">
                        <input type="checkbox" checked style="width:18px;height:18px;accent-color:#018181;" id="recipient-${i}" value="${m.email}">
                        <span>${escapeHtml(m.name)} (${escapeHtml(m.email)})</span>
                    </label>`;
                });
            } else {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fee2e2';
                resultDiv.style.border = '2px solid #ef4444';
                resultDiv.innerHTML = `<p style="margin: 0; color: #991b1b;">Export failed: ${data.error || 'Unknown error'}</p>`;
            }
        } catch (e) {
            btn.disabled = false;
            btnText.textContent = 'Export to Google Docs';
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#fee2e2';
            resultDiv.style.border = '2px solid #ef4444';
            resultDiv.innerHTML = `<p style="margin: 0; color: #991b1b;">Export failed: ${e.message}</p>`;
        }
    }

    async function sendEmailNotification() {
        const btn = document.getElementById('sendEmailBtn');
        const btnText = document.getElementById('sendEmailBtnText');
        btn.disabled = true; btnText.textContent = 'Sending...';
        try {
            // Get checked recipients
            const recipients = [];
            TEAM_MEMBERS.forEach((m, i) => {
                const cb = document.getElementById('recipient-' + i);
                if (cb && cb.checked) recipients.push(m.email);
            });
            // Add additional emails
            const additional = document.getElementById('additionalEmails')?.value || '';
            if (additional.trim()) {
                additional.split(',').forEach(e => { if (e.trim()) recipients.push(e.trim()); });
            }
            if (!recipients.length) { alert('Select at least one recipient'); btn.disabled = false; btnText.textContent = 'Send Email'; return; }

            const monthCap = selectedMonth.charAt(0).toUpperCase() + selectedMonth.slice(1);

            const resp = await fetch(`${API_BASE}/api/send-doc-notification`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    recipients,
                    doc_url: exportedDocUrl,
                    month: monthCap,
                    year: new Date().getFullYear()
                })
            });
            const data = await resp.json();
            const resultEl = document.getElementById('emailSendResult');
            resultEl.style.display = 'block';
            if (data.success) {
                resultEl.style.background = '#f0fdf4'; resultEl.style.color = '#059669';
                resultEl.textContent = 'Copy review notification sent to ' + recipients.join(', ');
                btnText.textContent = 'Sent!';
            } else {
                resultEl.style.background = '#fef2f2'; resultEl.style.color = '#dc3545';
                resultEl.textContent = 'Failed: ' + (data.error || '');
                btnText.textContent = 'Send Email';
            }
        } catch (e) {
            btnText.textContent = 'Error: ' + e.message;
        }
        btn.disabled = false;
    }

    // ============================================================
    // IMAGE GENERATION
    // ============================================================
    function setupImageStep() {
        // Pre-fill quick tip image prompt from generation
        if (generatedContent.quick_tip_image_prompt) {
            document.getElementById('quickTipImagePrompt').value = generatedContent.quick_tip_image_prompt;
        }
        // Show existing GTP image if URL is set
        const gtpImgUrl = selectedContent.guess_the_price?.image_url || '';
        if (gtpImgUrl && !gtpImgUrl.startsWith('data:')) {
            document.getElementById('gtpExistingImageNote').style.display = 'block';
            document.getElementById('gtpExistingImageThumb').src = gtpImgUrl;
        } else {
            document.getElementById('gtpExistingImageNote').style.display = 'none';
        }
        // Show existing generated images
        if (generatedImages.quick_tip) showImageResult('quick_tip', generatedImages.quick_tip.url || generatedImages.quick_tip);
        if (generatedImages.guess_the_price) showImageResult('guess_the_price', generatedImages.guess_the_price.url || generatedImages.guess_the_price);
    }

    function clearGTPExistingImage() {
        if (selectedContent.guess_the_price) {
            selectedContent.guess_the_price.image_url = '';
        }
        document.getElementById('gtpExistingImageNote').style.display = 'none';
        document.getElementById('gtpExistingImageThumb').src = '';
        // Also clear from generatedImages if set from step 4
        if (generatedImages.guess_the_price) {
            delete generatedImages.guess_the_price;
        }
    }

    async function generateSingleImage(section) {
        const promptId = section === 'quick_tip' ? 'quickTipImagePrompt' : 'gtpImagePrompt';
        const prompt = document.getElementById(promptId)?.value?.trim();
        if (!prompt) { alert('Enter an image prompt first'); return; }
        const resultId = section === 'quick_tip' ? 'quickTipImageResult' : 'gtpImageResult';
        document.getElementById(resultId).innerHTML = '<div class="loading"><div class="spinner" style="width:30px;height:30px;"></div><p>Generating image...</p></div>';
        try {
            const resp = await fetch(`${API_BASE}/api/generate-single-image`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, section })
            });
            const data = await resp.json();
            if (data.success && data.image_url) {
                generatedImages[section] = { url: data.image_url, prompt };
                showImageResult(section, data.image_url);
            } else {
                document.getElementById(resultId).innerHTML = '<p style="color:#dc3545;">Generation failed: ' + (data.error || '') + '</p>';
            }
        } catch (e) {
            document.getElementById(resultId).innerHTML = '<p style="color:#dc3545;">Error: ' + e.message + '</p>';
        }
    }

    function showImageResult(section, imageUrl) {
        const resultId = section === 'quick_tip' ? 'quickTipImageResult' : 'gtpImageResult';
        document.getElementById(resultId).innerHTML = `
            <img src="${imageUrl}" style="max-width:300px;border-radius:8px;display:block;margin-bottom:8px;">
            <button class="btn-small" style="background:#dc3545;" onclick="document.getElementById('${resultId}').innerHTML='';generatedImages['${section}']=null;">Remove</button>
        `;
    }

    function updatePromptWithStyle(section) {
        const styleId = section + 'ImageStyle';
        const promptId = section === 'quickTip' ? 'quickTipImagePrompt' : 'gtpImagePrompt';
        const styleSelect = document.getElementById(styleId);
        const promptTextarea = document.getElementById(promptId);
        if (!styleSelect || !promptTextarea) return;

        let currentPrompt = promptTextarea.value;
        // Remove any existing style prefix
        const stylePatterns = [
            /^Photorealistic:?\s*/i,
            /^Sketch \/ Illustration:?\s*/i,
            /^Watercolor:?\s*/i,
            /^Modern Flat Design:?\s*/i,
            /^Magazine Editorial:?\s*/i,
            /^Cartoon:?\s*/i,
            /^Infographic \/ Data Viz:?\s*/i
        ];
        stylePatterns.forEach(pattern => { currentPrompt = currentPrompt.replace(pattern, ''); });

        const styleLabels = {
            'photorealistic': 'Photorealistic',
            'sketch': 'Sketch / Illustration',
            'watercolor': 'Watercolor',
            'modern-flat': 'Modern Flat Design',
            'magazine': 'Magazine Editorial',
            'cartoon': 'Cartoon',
            'infographic': 'Infographic / Data Viz'
        };
        promptTextarea.value = `${styleLabels[styleSelect.value]}: ${currentPrompt.trim()}`;
    }

    function uploadCustomImage(section, input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const dataUrl = e.target.result;
            if (section === 'guess_the_price') {
                // Open cropper for GTP images
                gtpCropSourceUrl = dataUrl;
                gtpCropOrigin = 'step8';
                openGTPCropper();
            } else {
                generatedImages[section] = { url: dataUrl, prompt: 'uploaded' };
                showImageResult(section, dataUrl);
            }
        };
        reader.readAsDataURL(file);
    }

    // ============================================================
    // SUBJECT LINES
    // ============================================================
    function generateSubjectLinesWithTone() {
        const tone = document.getElementById('subjectToneSelect')?.value || selectedTone;
        selectedTone = tone;
        generateSubjectLines();
    }

    function regenerateSubjectLines() {
        document.getElementById('subjectLineResults').style.display = 'none';
        document.getElementById('toneSelection').style.display = 'block';
        subjectLinesGenerated = false;
    }

    async function generateSubjectLines() {
        // Hide tone selection, show loading
        document.getElementById('toneSelection').style.display = 'none';
        document.getElementById('subjectLineLoading').style.display = 'block';
        document.getElementById('subjectLineResults').style.display = 'none';

        try {
            const content = {
                news_of_month: { title: selectedContent.news_of_month?.title || '' },
                guess_the_price: { title: selectedContent.guess_the_price?.title || '' },
                quick_tip: generatedContent.quick_tip || ''
            };
            const resp = await fetch(`${API_BASE}/api/generate-subject-lines`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, month: selectedMonth, year: new Date().getFullYear(), tone: selectedTone })
            });
            const data = await resp.json();

            document.getElementById('subjectLineLoading').style.display = 'none';

            if (data.success) {
                document.getElementById('subjectLineResults').style.display = 'block';
                displaySubjectLineOptions(data.subject_lines || [], data.preheaders || []);
            } else {
                document.getElementById('toneSelection').style.display = 'block';
                alert('Failed to generate subject lines: ' + (data.error || ''));
            }
        } catch (e) {
            document.getElementById('subjectLineLoading').style.display = 'none';
            document.getElementById('toneSelection').style.display = 'block';
            alert('Failed to generate subject lines: ' + e.message);
        }
    }

    function displaySubjectLineOptions(subjectLines, preheaders) {
        // Subject line options as radio buttons
        const subjectList = document.getElementById('subjectLineList');
        subjectList.innerHTML = '';
        (subjectLines || []).forEach((line, index) => {
            const option = document.createElement('label');
            option.style.cssText = 'display: flex; align-items: flex-start; gap: 10px; padding: 12px; background: #f9fafb; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;';
            option.innerHTML = `
                <input type="radio" name="subjectLine" value="${escapeHtml(line)}" style="margin-top: 3px; accent-color: #018181;" onchange="document.getElementById('finalSubjectLine').value = this.value">
                <span style="font-size: 14px; line-height: 1.4;">${escapeHtml(line)}</span>
            `;
            option.onmouseover = () => option.style.borderColor = '#018181';
            option.onmouseout = () => option.style.borderColor = 'transparent';
            subjectList.appendChild(option);
        });

        // Preheader options as radio buttons
        const preheaderList = document.getElementById('preheaderList');
        preheaderList.innerHTML = '';
        (preheaders || []).forEach((line, index) => {
            const option = document.createElement('label');
            option.style.cssText = 'display: flex; align-items: flex-start; gap: 10px; padding: 12px; background: #f9fafb; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;';
            option.innerHTML = `
                <input type="radio" name="preheader" value="${escapeHtml(line)}" style="margin-top: 3px; accent-color: #018181;" onchange="document.getElementById('finalPreheader').value = this.value">
                <span style="font-size: 14px; line-height: 1.4;">${escapeHtml(line)}</span>
            `;
            option.onmouseover = () => option.style.borderColor = '#018181';
            option.onmouseout = () => option.style.borderColor = 'transparent';
            preheaderList.appendChild(option);
        });

        // Auto-select first options
        if (subjectLines && subjectLines.length > 0) {
            document.getElementById('finalSubjectLine').value = subjectLines[0];
            const firstSubjectRadio = subjectList.querySelector('input[type="radio"]');
            if (firstSubjectRadio) firstSubjectRadio.checked = true;
        }
        if (preheaders && preheaders.length > 0) {
            document.getElementById('finalPreheader').value = preheaders[0];
            const firstPreheaderRadio = preheaderList.querySelector('input[type="radio"]');
            if (firstPreheaderRadio) firstPreheaderRadio.checked = true;
        }
    }

    // ============================================================
    // PREVIEW + PUBLISH
    // ============================================================
    function cleanForEmail(text) {
        if (!text) return '';
        return text
            .replace(/#{1,6}\s+/g, '')           // ## headers  remove
            .replace(/\*\*(.*?)\*\*/g, '$1')      // **bold**  bold
            .replace(/\*(.*?)\*/g, '$1')           // *italic*  italic
            .replace(/__(.*?)__/g, '$1')           // __bold__  bold
            .replace(/_(.*?)_/g, '$1')             // _italic_  italic
            .replace(/<\/?p>/gi, '')               // Remove <p> tags
            .replace(/<br\s*\/?>/gi, ' ')          // <br>  space
            .replace(/<\/?strong>/gi, '')          // Remove <strong>
            .replace(/<\/?em>/gi, '')              // Remove <em>
            .replace(/<\/?b>/gi, '')               // Remove <b>
            .replace(/<\/?i>/gi, '')               // Remove <i>
            .replace(/&amp;/g, '&')                // Decode common HTML entities
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/\n\n+/g, ' ')               // Collapse double newlines
            .trim();
    }

    function generateConsumerNewsletterHTML() {
        const content = buildContentObject();
        const month = selectedMonth.charAt(0).toUpperCase() + selectedMonth.slice(1);
        const year = new Date().getFullYear();
        const preheader = document.getElementById('finalPreheader')?.value || 'Your monthly jewelry inspiration from BriteCo - ' + month + ' ' + year;

        // Build agenda items HTML - filter out AI preamble and "What's Inside" duplicates
        const agendaItems = (content.agenda_items || []).filter(item => {
            const text = (typeof item === 'string' ? item : String(item)).toLowerCase().trim();
            if (!text) return false;
            // Filter out "What's Inside" header duplicates
            if (text.match(/^[\s\W]*(what'?s?\s+inside|whats\s+inside)[\s\W]*$/i)) return false;
            // Filter out AI preamble lines like "Here are 4 bullet items for your newsletter:"
            if (text.match(/^here\s+are\s+\d+/i)) return false;
            if (text.match(/bullet\s*(items?|points?)/i)) return false;
            if (text.match(/^(below|following)\s+(are|is)/i)) return false;
            return true;
        });
        let agendaHtml = '';
        agendaItems.slice(0, 4).forEach(item => {
            const itemText = cleanForEmail(typeof item === 'string' ? item : String(item));
            agendaHtml += '<tr><td style="padding-bottom: 10px;"><p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 16px; line-height: 24px; font-weight: 400; color: #282e40;">' + itemText + '</p></td></tr>';
        });

        // Get images
        const qtImage = generatedImages.quick_tip ? (generatedImages.quick_tip.url || generatedImages.quick_tip) : '';
        const gtpImage = (generatedImages.guess_the_price ? (generatedImages.guess_the_price.url || generatedImages.guess_the_price) : '') || content.guess_the_price?.image_url || '';

        // Quick tip image block
        let quickTipImageBlock = '';
        if (qtImage) {
            quickTipImageBlock = '<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-top: 20px;"><tr><td><img src="' + qtImage + '" width="590" alt="Quick Tip" style="width: 100%; max-width: 590px; height: auto; display: block; border-radius: 6px;" class="mobile-img-full"></td></tr></table>';
        }

        // Clean all text content for email rendering (strip markdown, HTML tags)
        let rawIntro = content.intro || '';
        // Strip AI-generated prefixes like "May Newsletter Intro:", "February Newsletter Introduction:", etc.
        rawIntro = rawIntro.replace(/^(?:\w+\s+)?newsletter\s+intro(?:duction)?[\s:;\-]*/i, '').trim();
        rawIntro = rawIntro.replace(/^(?:january|february|march|april|may|june|july|august|september|october|november|december)\s+intro(?:duction)?[\s:;\-]*/i, '').trim();
        // Strip quoted wrapping
        if (rawIntro.startsWith('"') && rawIntro.endsWith('"')) rawIntro = rawIntro.slice(1, -1).trim();
        if (rawIntro.startsWith("'") && rawIntro.endsWith("'")) rawIntro = rawIntro.slice(1, -1).trim();
        const cleanIntro = cleanForEmail(rawIntro);
        const nom = content.news_of_month || {};
        // Strip AI labels like "Featured Video:", "News of the Month:", etc.
        let rawNomDesc = (nom.description || '').replace(/^(featured\s+video|video\s+description|news\s+of\s+the\s+month)[\s:;\-]+/i, '').trim();
        const cleanNomDesc = cleanForEmail(rawNomDesc);
        const ta = content.trend_alert || {};
        let rawTaDesc = (ta.description || '').replace(/^(featured\s+video|video\s+description|trend\s+alert)[\s:;\-]+/i, '').trim();
        const cleanTaDesc = cleanForEmail(rawTaDesc);
        const blogs = content.blog_articles || [{}, {}];
        const blog1 = blogs[0] || {};
        const blog2 = blogs[1] || {};
        const gtp = content.guess_the_price || {};
        const cleanGtpQuestion = cleanForEmail(gtp.question || 'Think you know the price?');
        // Strip AI-generated prefixes from quick tip like "February Quick Tip:", "May Quick Tip:", etc.
        let rawQuickTip = content.quick_tip || '';
        rawQuickTip = rawQuickTip.replace(/^(?:january|february|march|april|may|june|july|august|september|october|november|december)\s+quick\s*tip[\s:;\-]*/i, '').trim();
        rawQuickTip = rawQuickTip.replace(/^quick\s*tip[\s:;\-]*/i, '').trim();
        if (rawQuickTip.startsWith('"') && rawQuickTip.endsWith('"')) rawQuickTip = rawQuickTip.slice(1, -1).trim();
        const cleanQuickTip = cleanForEmail(rawQuickTip);

        return '<!DOCTYPE html>\n<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">\n<head>\n<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1">\n<meta http-equiv="X-UA-Compatible" content="IE=edge">\n<meta name="x-apple-disable-message-reformatting">\n<meta name="format-detection" content="telephone=no,address=no,email=no,date=no,url=no">\n<title>BriteCo Consumer Newsletter - ' + month + ' ' + year + '</title>\n<style>\nhtml, body { margin: 0 auto !important; padding: 0 !important; height: 100% !important; width: 100% !important; }\n* { -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; }\ntable, td { mso-table-lspace: 0pt !important; mso-table-rspace: 0pt !important; }\ntable { border-spacing: 0 !important; border-collapse: collapse !important; margin: 0 auto !important; }\n.badge-table { margin: 0 0 30px 0 !important; }\nimg { -ms-interpolation-mode: bicubic; border: 0; height: auto; line-height: 100%; outline: none; text-decoration: none; }\na { text-decoration: none; }\n.button-link { transition: all 100ms ease-in; }\n.button-link:hover { opacity: 0.9; }\n@media screen and (max-width: 700px) {\n.mobile-full { width: 100% !important; max-width: 100% !important; min-width: 100% !important; }\n.mobile-padding { padding-left: 20px !important; padding-right: 20px !important; }\n.mobile-stack { display: block !important; width: 100% !important; max-width: 100% !important; }\n.mobile-img-full { width: 100% !important; height: auto !important; max-width: 100% !important; }\n.gtp-image { display: block !important; width: 100% !important; max-width: 100% !important; padding-bottom: 20px !important; padding-right: 0 !important; text-align: center !important; }\n.gtp-image img { width: 100% !important; max-width: 100% !important; margin: 0 auto !important; }\n.gtp-details { display: block !important; width: 100% !important; }\n.gtp-hero-img { height: auto !important; }\n.whats-inside-spacer { height: 25px !important; }\n.section-badge p { font-size: 14px !important; padding: 5px 14px !important; }\n.badge-table { margin: 0 0 20px 0 !important; }\n.cta-heading { font-size: 24px !important; line-height: 32px !important; }\n.cta-btn { display: block !important; width: 100% !important; margin-bottom: 12px !important; text-align: center !important; }\n}\nu + .body .mobile-full { width: 100% !important; max-width: 100% !important; }\nu + .body .mobile-padding { padding-left: 20px !important; padding-right: 20px !important; }\nu + .body .gtp-image { display: block !important; width: 100% !important; max-width: 100% !important; padding-right: 0 !important; padding-bottom: 20px !important; text-align: center !important; }\nu + .body .gtp-image img { width: 100% !important; max-width: 100% !important; }\nu + .body .gtp-details { display: block !important; width: 100% !important; }\nu + .body .gtp-hero-img { height: auto !important; }\nu + .body .whats-inside-spacer { height: 25px !important; }\nu + .body .mobile-img-full { width: 100% !important; max-width: 100% !important; height: auto !important; }\nu + .body .section-badge { font-size: 14px !important; }\nu + .body .cta-btn { display: block !important; width: 100% !important; margin-bottom: 12px !important; }\nu + .body .cta-heading { font-size: 24px !important; }\n</style>\n</head>\n<body width="100%" class="body" style="margin: 0; padding: 0 !important; mso-line-height-rule: exactly; background-color: #e8e8e8;">\n\n<div style="display: none; max-height: 0px; overflow: hidden;">' + preheader + '</div>\n\n<div class="body" role="article" aria-roledescription="email" aria-label="BriteCo Newsletter" lang="en" style="font-size: 16px; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; background-color: #e8e8e8;">\n\n<table align="center" role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin: 0 auto; max-width: 680px;" class="mobile-full">\n\n<!-- HEADER -->\n<tr>\n<td align="center" style="background-color: #272d3f; padding: 30px 40px;">\n<a href="https://brite.co" target="_blank">\n<img src="/static/briteco-logo-white.png" width="140" alt="BriteCo" style="width: 140px; max-width: 140px; height: auto; display: block;">\n</a>\n</td>\n</tr>\n\n<!-- INTRO -->\n<tr>\n<td style="background-color: #f2f2f2; padding: 35px 45px; text-align: center;" class="mobile-padding">\n<p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 20px; line-height: 30px; font-weight: 400; color: #4b4b4b; font-style: italic;">' + cleanIntro + '</p>\n</td>\n</tr>\n\n<!-- WHATS INSIDE -->\n<tr>\n<td style="background-color: #ffffff; padding: 0;">\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">\n<tr><td style="height: 3px; background-color: #008181; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>\n<tr>\n<td style="padding: 30px 45px;" class="mobile-padding">\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" align="center" style="margin: 0 auto 20px auto;">\n<tr>\n<td style="background-color: #44b9b4; padding: 6px 18px; border-radius: 4px;">\n<p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 14px; font-weight: 600; color: #ffffff; text-transform: uppercase; letter-spacing: 1px;">What\'s Inside</p>\n</td>\n</tr>\n</table>\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">\n' + agendaHtml + '\n</table>\n</td>\n</tr>\n<tr><td style="height: 3px; background-color: #008181; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>\n</table>\n</td>\n</tr>\n\n<tr><td style="height: 20px; font-size: 1px; line-height: 1px;" class="whats-inside-spacer">&nbsp;</td></tr>\n\n<!-- NEWS OF THE MONTH -->\n<tr>\n<td>\n<div style="background-color: #466f88;">\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">\n<tr>\n<td style="padding: 30px 45px 0 45px;" class="mobile-padding">\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" class="badge-table" style="margin: 0 0 30px 0;">\n<tr>\n<td style="background-color: #44b9b4; padding: 6px 18px; border-radius: 4px;">\n<p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 17px; font-weight: 700; color: #ffffff;" class="section-badge">News of the Month</p>\n</td>\n</tr>\n</table>\n</td>\n</tr>\n<tr>\n<td style="padding: 0 45px 15px 45px;" class="mobile-padding">\n<h2 style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 22px; line-height: 30px; font-weight: 700; color: #ffffff;">' + (nom.title || '') + '</h2>\n</td>\n</tr>\n<tr>\n<td style="padding: 0 45px 20px 45px;" class="mobile-padding">\n<a href="' + (nom.video_url || '#') + '" target="_blank">\n<img src="' + (nom.thumbnail_url || '') + '" width="590" alt="' + (nom.title || '') + '" style="width: 100%; max-width: 590px; height: auto; display: block; border-radius: 6px;" class="mobile-img-full">\n</a>\n</td>\n</tr>\n<tr>\n<td style="padding: 0 45px 10px 45px;" class="mobile-padding">\n<p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 16px; line-height: 26px; font-weight: 400; color: #ffffff;">' + cleanNomDesc + '</p>\n</td>\n</tr>\n<tr>\n<td style="padding: 0 45px 35px 45px;" class="mobile-padding">\n<a href="' + (nom.video_url || '#') + '" target="_blank" style="font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 16px; font-weight: 600; color: #31D7CA; text-decoration: underline;">Watch the full video here &rarr;</a>\n</td>\n</tr>\n</table>\n</div>\n</td>\n</tr>\n\n<tr><td style="height: 20px; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>\n\n<!-- TREND ALERT -->\n<tr>\n<td>\n<div style="background-color: #466f88;">\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">\n<tr>\n<td style="padding: 30px 45px 0 45px;" class="mobile-padding">\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" class="badge-table" style="margin: 0 0 30px 0;">\n<tr>\n<td style="background-color: #44b9b4; padding: 6px 18px; border-radius: 4px;">\n<p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 17px; font-weight: 700; color: #ffffff;" class="section-badge">Trend Alert</p>\n</td>\n</tr>\n</table>\n</td>\n</tr>\n<tr>\n<td style="padding: 0 45px 15px 45px;" class="mobile-padding">\n<h2 style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 22px; line-height: 30px; font-weight: 700; color: #ffffff;">' + (ta.title || '') + '</h2>\n</td>\n</tr>\n<tr>\n<td style="padding: 0 45px 20px 45px;" class="mobile-padding">\n<a href="' + (ta.video_url || '#') + '" target="_blank">\n<img src="' + (ta.thumbnail_url || '') + '" width="590" alt="' + (ta.title || '') + '" style="width: 100%; max-width: 590px; height: auto; display: block; border-radius: 6px;" class="mobile-img-full">\n</a>\n</td>\n</tr>\n<tr>\n<td style="padding: 0 45px 10px 45px;" class="mobile-padding">\n<p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 16px; line-height: 26px; font-weight: 400; color: #ffffff;">' + cleanTaDesc + '</p>\n</td>\n</tr>\n<tr>\n<td style="padding: 0 45px 35px 45px;" class="mobile-padding">\n<a href="' + (ta.video_url || '#') + '" target="_blank" style="font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 16px; font-weight: 600; color: #31D7CA; text-decoration: underline;">Watch the full video here &rarr;</a>\n</td>\n</tr>\n</table>\n</div>\n</td>\n</tr>\n\n<tr><td style="height: 20px; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>\n\n<!-- BLOG ARTICLES -->\n<tr>\n<td style="background-color: #ffffff; padding: 30px 45px;" class="mobile-padding">\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="border: 2px solid #008181; border-radius: 6px; overflow: hidden; margin-bottom: 24px;">\n<tr><td><a href="' + (blog1.url || '#') + '" target="_blank"><img src="' + (blog1.featured_image_url || '') + '" width="590" alt="' + (blog1.title || '') + '" style="width: 100%; max-width: 590px; height: auto; display: block;" class="mobile-img-full"></a></td></tr>\n<tr><td style="padding: 20px 22px 8px 22px;"><p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 18px; line-height: 26px; font-weight: 700; color: #282e40;">' + (blog1.title || '') + '</p></td></tr>\n<tr><td style="padding: 8px 22px 22px 22px;"><a href="' + (blog1.url || '#') + '" target="_blank" style="display: inline-block; background-color: #fe8916; color: #ffffff; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 13px; font-weight: 700; padding: 10px 28px; text-decoration: none; border-radius: 4px; letter-spacing: 0.5px;" class="button-link">READ MORE</a></td></tr>\n</table>\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="border: 2px solid #008181; border-radius: 6px; overflow: hidden;">\n<tr><td><a href="' + (blog2.url || '#') + '" target="_blank"><img src="' + (blog2.featured_image_url || '') + '" width="590" alt="' + (blog2.title || '') + '" style="width: 100%; max-width: 590px; height: auto; display: block;" class="mobile-img-full"></a></td></tr>\n<tr><td style="padding: 20px 22px 8px 22px;"><p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 18px; line-height: 26px; font-weight: 700; color: #282e40;">' + (blog2.title || '') + '</p></td></tr>\n<tr><td style="padding: 8px 22px 22px 22px;"><a href="' + (blog2.url || '#') + '" target="_blank" style="display: inline-block; background-color: #fe8916; color: #ffffff; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 13px; font-weight: 700; padding: 10px 28px; text-decoration: none; border-radius: 4px; letter-spacing: 0.5px;" class="button-link">READ MORE</a></td></tr>\n</table>\n</td>\n</tr>\n\n<tr><td style="height: 20px; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>\n\n<!-- GUESS THE PRICE -->\n<tr>\n<td style="background-color: #ffffff; padding: 0;">\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">\n<tr><td style="height: 3px; background-color: #008181; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>\n<tr>\n<td style="padding: 30px 45px;" class="mobile-padding">\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" class="badge-table" style="margin: 0 0 30px 0;">\n<tr>\n<td style="background-color: #44b9b4; padding: 6px 18px; border-radius: 4px;">\n<p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 17px; font-weight: 700; color: #ffffff;" class="section-badge">Guess the Price</p>\n</td>\n</tr>\n</table>\n<h2 style="margin: 0 0 20px 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 22px; line-height: 30px; font-weight: 700; color: #282e40;">' + (gtp.title || '') + '</h2>\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-bottom: 30px;">\n<tr>\n<td align="center">\n<img src="' + (gtpImage || '') + '" width="590" height="350" alt="' + (gtp.title || '') + '" style="width: 100%; max-width: 590px; height: 350px; object-fit: cover; display: block; border-radius: 6px;" class="mobile-img-full gtp-hero-img">\n</td>\n</tr>\n</table>\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">\n<tr><td style="padding-bottom: 14px;"><p style="margin: 0 0 3px 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 13px; font-weight: 700; color: #008181; text-transform: uppercase; letter-spacing: 0.5px;">Material</p><p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 16px; line-height: 26px; font-weight: 400; color: #282e40;">' + (gtp.material || '') + '</p></td></tr>\n<tr><td style="padding-bottom: 14px;"><p style="margin: 0 0 3px 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 13px; font-weight: 700; color: #008181; text-transform: uppercase; letter-spacing: 0.5px;">Found In</p><p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 16px; line-height: 26px; font-weight: 400; color: #282e40;">' + (gtp.found_in || '') + '</p></td></tr>\n<tr><td style="padding-bottom: 14px;"><p style="margin: 0 0 3px 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 13px; font-weight: 700; color: #008181; text-transform: uppercase; letter-spacing: 0.5px;">Where It Lives</p><p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 16px; line-height: 26px; font-weight: 400; color: #282e40;">' + (gtp.where_it_lives || '') + '</p></td></tr>\n<tr><td style="padding-bottom: 20px;"><p style="margin: 0 0 3px 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 13px; font-weight: 700; color: #008181; text-transform: uppercase; letter-spacing: 0.5px;">Fun Fact</p><p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 16px; line-height: 26px; font-weight: 400; color: #282e40;">' + (gtp.fun_fact || '') + '</p></td></tr>\n</table>\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-top: 25px;">\n<tr>\n<td style="padding: 16px 20px; background-color: #f2f2f2; border-radius: 6px; text-align: center;">\n<a href="' + (gtp.link || '#') + '" target="_blank" style="font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 17px; line-height: 24px; font-weight: 700; color: #008181; text-decoration: none;">' + cleanGtpQuestion + ' <span style="text-decoration: underline;">Click here to find out!</span></a>\n</td>\n</tr>\n</table>\n</td>\n</tr>\n<tr><td style="height: 3px; background-color: #008181; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>\n</table>\n</td>\n</tr>\n\n<tr><td style="height: 20px; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>\n\n<!-- QUICK TIP -->\n<tr>\n<td style="background-color: #ffffff; padding: 0;">\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">\n<tr><td style="height: 3px; background-color: #008181; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>\n<tr>\n<td style="padding: 30px 45px;" class="mobile-padding">\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" class="badge-table" style="margin: 0 0 30px 0;">\n<tr>\n<td style="background-color: #44b9b4; padding: 6px 18px; border-radius: 4px;">\n<p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 17px; font-weight: 700; color: #ffffff;" class="section-badge">Quick Tip</p>\n</td>\n</tr>\n</table>\n<p style="margin: 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 16px; line-height: 26px; font-weight: 400; color: #282e40;">' + cleanQuickTip + '</p>\n' + quickTipImageBlock + '\n</td>\n</tr>\n<tr><td style="height: 3px; background-color: #008181; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>\n</table>\n</td>\n</tr>\n\n<tr><td style="height: 20px; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>\n\n<!-- INSURANCE CTA -->\n<tr>\n<td>\n<div style="background-color: #466f88;">\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">\n<tr>\n<td style="padding: 45px 45px; text-align: center;" class="mobile-padding">\n<h2 style="margin: 0 0 12px 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 28px; line-height: 36px; font-weight: 700; color: #ffffff;" class="cta-heading">Cover Your Sparkle</h2>\n<p style="margin: 0 0 25px 0; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 16px; line-height: 26px; font-weight: 400; color: #ffffff;">BriteCo offers affordable, comprehensive insurance that\'s easy to set up and gives you peace of mind.</p>\n<table role="presentation" cellspacing="0" cellpadding="0" border="0" align="center" style="margin: 0 auto;">\n<tr>\n<td style="padding-right: 12px;">\n<a href="https://brite.co/jewelry-insurance/" target="_blank" style="display: inline-block; background-color: #fe8916; color: #ffffff; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 14px; font-weight: 700; padding: 14px 28px; text-decoration: none; border-radius: 4px; letter-spacing: 0.5px;" class="button-link">JEWELRY INSURANCE</a>\n</td>\n<td style="padding-left: 12px;">\n<a href="https://brite.co/wedding-insurance/" target="_blank" style="display: inline-block; background-color: #fe8916; color: #ffffff; font-family: \'Wix Madefor Display\', Arial, Helvetica, sans-serif; font-size: 14px; font-weight: 700; padding: 14px 28px; text-decoration: none; border-radius: 4px; letter-spacing: 0.5px;" class="button-link">WEDDING INSURANCE</a>\n</td>\n</tr>\n</table>\n</td>\n</tr>\n</table>\n</div>\n</td>\n</tr>\n\n<!-- FOOTER -->\n<tr>\n<td style="background-color: #272d3e; padding: 35px 45px; text-align: center;" class="mobile-padding">\n<a href="https://brite.co" target="_blank">\n<img src="/static/briteco-logo-white.png" width="100" alt="BriteCo" style="width: 100px; max-width: 100px; height: auto; display: block; margin: 0 auto;">\n</a>\n</td>\n</tr>\n\n<tr><td style="height: 20px; font-size: 1px; line-height: 1px;">&nbsp;</td></tr>\n\n</table>\n</div>\n</body>\n</html>';
    }

    function populatePreview() {
        const subjectLine = document.getElementById('finalSubjectLine')?.value || 'BriteCo Newsletter - ' + selectedMonth;
        const preheader = document.getElementById('finalPreheader')?.value || '';
        document.getElementById('previewSubjectLine').textContent = subjectLine;
        document.getElementById('previewPreheader').textContent = preheader;
        document.getElementById('ontraportSubjectInput').value = subjectLine;

        const previewDiv = document.getElementById('newsletterPreview');
        const previewHtml = generateConsumerNewsletterHTML();
        renderedEmailHTML = previewHtml;
        previewDiv.innerHTML = previewHtml;
        enableNewsletterEditing();
    }

    function refreshPreview() { populatePreview(); }

    function toggleHTMLCode() {
        const codeView = document.getElementById('htmlCodeView');
        if (codeView.style.display === 'none' || !codeView.style.display) {
            const html = renderedEmailHTML || document.getElementById('newsletterPreview').innerHTML;
            document.getElementById('htmlCode').textContent = html;
            codeView.style.display = 'block';
        } else {
            codeView.style.display = 'none';
        }
    }

    function copyHTMLCode() {
        let html = renderedEmailHTML || document.getElementById('newsletterPreview').innerHTML;
        // Replace base64 images with placeholder URLs
        let ci = 0;
        html = html.replace(/data:image\/[a-z]+;base64,[A-Za-z0-9+\/=]+/g, () => {
            ci++;
            return 'https://REPLACE-WITH-HOSTED-URL/image-' + ci + '.png';
        });
        navigator.clipboard.writeText(html).then(() => {
            alert('HTML copied to clipboard!');
        }).catch(() => {
            const ta = document.createElement('textarea');
            ta.value = html; document.body.appendChild(ta);
            ta.select(); document.execCommand('copy');
            document.body.removeChild(ta);
            alert('HTML copied to clipboard!');
        });
    }

    function saveSubjectEdit(el) {
        document.getElementById('finalSubjectLine').value = el.textContent;
    }

    function savePreheaderEdit(el) {
        document.getElementById('finalPreheader').value = el.textContent;
    }

    async function uploadImagesToGCS() {
        const images = {};
        const sections = ['quick_tip', 'guess_the_price'];
        for (const section of sections) {
            const img = generatedImages[section];
            if (img) {
                const imgUrl = (typeof img === 'string') ? img : (img.url || (img.image_data ? 'data:image/png;base64,' + img.image_data : null));
                if (imgUrl && (imgUrl.startsWith('data:image') || imgUrl.startsWith('http'))) {
                    images[section] = imgUrl;
                    console.log('Will upload ' + section + ': ' + (imgUrl.startsWith('data:') ? 'base64 (' + imgUrl.length + ' chars)' : imgUrl.substring(0, 80)));
                }
            }
        }
        // Also capture GTP external URL from selectedContent if not already in generatedImages
        if (!images['guess_the_price']) {
            const gtpUrl = selectedContent.guess_the_price?.image_url;
            if (gtpUrl && gtpUrl.startsWith('http')) {
                images['guess_the_price'] = gtpUrl;
                console.log('Will upload guess_the_price (external): ' + gtpUrl.substring(0, 80));
            }
        }
        // Also upload static assets so they work in email clients
        images['_logo'] = window.location.origin + '/static/briteco-logo-white.png';

        try {
            const resp = await fetch(`${API_BASE}/api/upload-images-to-gcs`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ images, month: selectedMonth, year: new Date().getFullYear() })
            });
            const result = await resp.json();
            console.log('GCS upload response:', result);
            return result;
        } catch (e) {
            console.error('GCS upload error:', e);
            return { success: false, urls: {} };
        }
    }

    async function pushToOntraport() {
        const subject = document.getElementById('ontraportSubjectInput')?.value || document.getElementById('finalSubjectLine')?.value;
        if (!subject) { alert('Please enter a subject line'); return; }

        const btn = document.getElementById('ontraportBtn');
        const btnText = document.getElementById('ontraportBtnText');
        const resultDiv = document.getElementById('ontraportResult');
        const originalText = btnText.textContent;

        try {
            // Step 1: Upload images to GCS
            btnText.textContent = 'Uploading images...';
            btn.disabled = true;
            resultDiv.style.display = 'none';

            const uploadResult = await uploadImagesToGCS();
            const gcsUrls = uploadResult.success ? (uploadResult.urls || {}) : {};
            console.log('GCS upload result:', uploadResult);

            // Step 2: Generate HTML first (with base64 data URIs embedded)
            btnText.textContent = 'Generating HTML...';
            let html = generateConsumerNewsletterHTML();

            // Replace static asset paths with GCS-hosted URLs (or fallback to app URL)
            const logoUrl = gcsUrls['_logo'] || (window.location.origin + '/static/briteco-logo-white.png');
            html = html.replace(/src="\/static\/briteco-logo-white\.png"/g, 'src="' + logoUrl + '"');
            console.log('Static assets - logo:', logoUrl);

            // Step 3: Build base64  GCS URL mapping (jeweler approach)
            const base64ToUrl = {};
            for (const [section, gcsUrl] of Object.entries(gcsUrls)) {
                const img = generatedImages[section];
                if (img) {
                    const dataUrl = (typeof img === 'string') ? img : (img.url || (img.image_data ? 'data:image/png;base64,' + img.image_data : null));
                    if (dataUrl) base64ToUrl[dataUrl] = gcsUrl;
                }
            }

            // Step 4: Replace base64 data URIs with GCS URLs in the HTML
            let imgIndex = 0;
            html = html.replace(/data:image\/[a-z]+;base64,[A-Za-z0-9+\/=]+/g, (match) => {
                // Check if we have a GCS URL for this exact base64 string
                if (base64ToUrl[match]) {
                    console.log('Replaced base64 image with GCS URL');
                    return base64ToUrl[match];
                }
                // Fallback: check if any mapping value starts with this match
                for (const [b64, url] of Object.entries(base64ToUrl)) {
                    if (b64.includes(match) || match.includes(b64)) {
                        console.log('Replaced base64 image with GCS URL (partial match)');
                        return url;
                    }
                }
                imgIndex++;
                console.warn('Unhosted data URL found in HTML, image ' + imgIndex);
                return 'https://REPLACE-WITH-HOSTED-URL/image-' + imgIndex + '.png';
            });

            // Also replace any external URLs that were re-hosted to GCS
            for (const [section, gcsUrl] of Object.entries(gcsUrls)) {
                if (section === 'guess_the_price' && selectedContent.guess_the_price?.image_url) {
                    const origUrl = selectedContent.guess_the_price.image_url;
                    if (origUrl.startsWith('http') && !origUrl.includes('storage.googleapis.com') && html.includes(origUrl)) {
                        html = html.split(origUrl).join(gcsUrl);
                        console.log('Replaced external GTP URL with GCS URL');
                    }
                }
            }
            console.log('Image replacements complete. Remaining data URLs:', (html.match(/data:image/g) || []).length);

            // Step 4: Push to Ontraport
            btnText.textContent = 'Pushing to Ontraport...';
            const response = await fetch(`${API_BASE}/api/push-to-ontraport`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ subject, month: selectedMonth, html })
            });
            const data = await response.json();

            if (data.success) {
                // Save draft and publish
                btnText.textContent = 'Saving & publishing...';
                await saveDraft();
                await publishDraft();

                const uploadedCount = Object.keys(gcsUrls).length;
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#f0fdf4';
                resultDiv.style.border = '2px solid #22c55e';
                resultDiv.innerHTML = '<p style="margin: 0; color: #166534; font-weight: 600;">Successfully pushed to Ontraport!</p>'
                    + (uploadedCount > 0 ? '<p style="margin: 8px 0 0 0; color: #166534; font-size: 14px;">' + uploadedCount + ' image(s) hosted on GCS.</p>' : '');
            } else {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fef2f2';
                resultDiv.style.border = '2px solid #dc3545';
                resultDiv.innerHTML = '<p style="margin: 0; color: #dc3545;">Failed: ' + (data.error || 'Unknown error') + '</p>';
            }
        } catch (error) {
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#fef2f2';
            resultDiv.style.border = '2px solid #dc3545';
            resultDiv.innerHTML = '<p style="margin: 0; color: #dc3545;">Error: ' + error.message + '</p>';
        } finally {
            btnText.textContent = originalText;
            btn.disabled = false;
        }
    }

    async function publishDraft() {
        try {
            const year = new Date().getFullYear();
            const userPrefix = ((window.AUTH_USER && window.AUTH_USER.email) || 'unknown').split('@')[0].replace(/\./g, '-');
            const resp = await fetch(`${API_BASE}/api/publish-draft`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file: `drafts/${selectedMonth}-${year}-${userPrefix}.json` })
            });
            const data = await resp.json();
            if (data.success) { loadPublishedNewsletters(); }
        } catch (e) { console.error('Publish error:', e); }
    }

    // ============================================================
    // DRAFT MANAGEMENT
    // ============================================================
    async function saveDraft() {
        if (!selectedMonth) return;
        try {
            const userEmail = (window.AUTH_USER && window.AUTH_USER.email) || 'unknown';
            await fetch(`${API_BASE}/api/save-draft`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    month: selectedMonth,
                    year: new Date().getFullYear(),
                    currentStep: currentStep,
                    newsletterType: 'consumer',
                    selectedContent: selectedContent,
                    generatedContent: generatedContent,
                    generatedImages: generatedImages,
                    generatedPrompts: generatedPrompts,
                    introText: document.getElementById('introContent')?.value || '',
                    quickTipText: document.getElementById('quickTipContent')?.value || '',
                    subjectLine: document.getElementById('finalSubjectLine')?.value || '',
                    preheader: document.getElementById('finalPreheader')?.value || '',
                    savedBy: userEmail
                })
            });
            console.log('[Draft] Saved');
            loadDrafts();
        } catch (e) { console.error('[Draft] Save failed:', e); }
    }

    async function loadDrafts() {
        try {
            const resp = await fetch(`${API_BASE}/api/list-drafts`);
            const data = await resp.json();
            if (data.success && data.drafts && data.drafts.length > 0) {
                const grid = document.getElementById('draftsGrid');
                document.getElementById('draftsEmpty').style.display = 'none';
                grid.innerHTML = '';
                data.drafts.forEach(d => {
                    const monthCap = d.month ? d.month.charAt(0).toUpperCase() + d.month.slice(1) : '?';
                    const savedBy = d.lastSavedBy || 'unknown';
                    const savedAt = d.lastSavedAt ? new Date(d.lastSavedAt).toLocaleString('en-US', { timeZone: 'America/Chicago', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) : '';
                    const card = document.createElement('div');
                    card.style.cssText = 'background:white;border-radius:12px;padding:25px;cursor:pointer;position:relative;transition:all 0.2s;';
                    card.innerHTML = `
                        <button onclick="event.stopPropagation();if(confirm('Delete draft for ${monthCap} ${d.year}?'))deleteDraft('${d.filename}')" style="position:absolute;top:8px;right:8px;background:#dc3545;color:white;border:none;border-radius:50%;width:24px;height:24px;font-size:14px;cursor:pointer;opacity:0.7;">&times;</button>
                        <h4 style="color:#018181;font-size:18px;margin-bottom:8px;">${monthCap} ${d.year}</h4>
                        <p style="color:#6b7280;font-size:14px;">Created by: ${escapeHtml(savedBy)}</p>
                        <p style="color:#6b7280;font-size:14px;">${savedAt} CT</p>
                    `;
                    card.onclick = () => loadDraft(d.filename);
                    grid.appendChild(card);
                });
            } else {
                document.getElementById('draftsEmpty').style.display = 'block';
                document.getElementById('draftsGrid').innerHTML = '';
            }
        } catch (e) { console.error('[Drafts] Load failed:', e); }
    }

    async function loadDraft(filename) {
        try {
            const resp = await fetch(`${API_BASE}/api/load-draft?file=${encodeURIComponent(filename)}`);
            const data = await resp.json();
            if (!data.success || !data.draft) { alert('Failed to load draft'); return; }
            const d = data.draft;

            // Restore state
            selectedMonth = d.month || '';
            selectedContent = d.selectedContent || { news_of_month: null, trend_alert: null, blog_1: null, blog_2: null, guess_the_price: null };
            generatedContent = d.generatedContent || {};
            generatedImages = d.generatedImages || {};
            generatedPrompts = d.generatedPrompts || {};

            // Restore textareas
            if (d.introText) document.getElementById('introContent').value = d.introText;
            if (d.quickTipText) document.getElementById('quickTipContent').value = d.quickTipText;
            if (d.subjectLine) document.getElementById('finalSubjectLine').value = d.subjectLine;
            if (d.preheader) document.getElementById('finalPreheader').value = d.preheader;

            // Highlight selected month
            document.querySelectorAll('.month-card').forEach(c => {
                c.classList.remove('selected');
                if (c.textContent.toLowerCase().includes(selectedMonth)) c.classList.add('selected');
            });
            document.getElementById('monthNextBtn').disabled = !selectedMonth;

            // Restore video slots
            updateVideoSlots();
            updateStep2NextButton();
            updateBlogBanner();

            // Restore GTP form if data exists
            if (selectedContent.guess_the_price) {
                const gtp = selectedContent.guess_the_price;
                document.getElementById('gtpDetailsForm').style.display = 'block';
                document.getElementById('gtpTitle').value = gtp.title || '';
                document.getElementById('gtpImageUrl').value = gtp.image_url || '';
                document.getElementById('gtpMaterial').value = gtp.material || '';
                document.getElementById('gtpFoundIn').value = gtp.found_in || '';
                document.getElementById('gtpWhereItLives').value = gtp.where_it_lives || '';
                document.getElementById('gtpFunFact').value = gtp.fun_fact || '';
                document.getElementById('gtpSourceLink').value = gtp.source_link || '';
                document.getElementById('step4NextBtn').disabled = false;
            }

            // Mark things as already generated if draft has content
            if (d.introText || d.quickTipText || generatedContent.intro) introAndTipGenerated = true;
            if (d.subjectLine) subjectLinesGenerated = true;
            if (generatedPrompts && Object.keys(generatedPrompts).length) promptsAlreadyGenerated = true;

            // Navigate to saved step
            const step = d.currentStep || 1;
            if (typeof step === 'string' && step.includes('b')) {
                if (step === '6b') populateReviewContent();
                showStep(step);
            } else {
                goToStep(typeof step === 'string' ? parseInt(step) : step);
            }
        } catch (e) {
            console.error('[Draft] Load failed:', e);
            alert('Error loading draft');
        }
    }

    async function deleteDraft(filename) {
        try {
            await fetch(`${API_BASE}/api/delete-draft`, {
                method: 'DELETE', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file: filename })
            });
            loadDrafts();
        } catch (e) { console.error('[Draft] Delete failed:', e); }
    }

    async function deletePublished(filename) {
        try {
            await fetch(`${API_BASE}/api/delete-published`, {
                method: 'DELETE', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file: filename })
            });
            loadPublishedNewsletters();
        } catch (e) { console.error('[Published] Delete failed:', e); }
    }

    // ============================================================
    // PUBLISHED NEWSLETTERS
    // ============================================================
    async function loadPublishedNewsletters() {
        try {
            const resp = await fetch(`${API_BASE}/api/list-published`);
            const data = await resp.json();
            if (data.success && data.newsletters && data.newsletters.length > 0) {
                const grid = document.getElementById('publishedGrid');
                document.getElementById('publishedEmpty').style.display = 'none';
                grid.innerHTML = '';
                data.newsletters.forEach(n => {
                    const monthCap = n.month ? n.month.charAt(0).toUpperCase() + n.month.slice(1) : '?';
                    const savedBy = n.lastSavedBy || 'unknown';
                    const savedAt = n.lastSavedAt ? new Date(n.lastSavedAt).toLocaleString('en-US', { timeZone: 'America/Chicago', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) : '';
                    const card = document.createElement('div');
                    card.style.cssText = 'background:#2d3748;border-radius:12px;overflow:hidden;transition:all 0.2s;cursor:pointer;position:relative;';
                    card.innerHTML = `
                        <button onclick="event.stopPropagation();if(confirm('Delete published newsletter for ${monthCap} ${n.year}?'))deletePublished('${n.filename}')" style="position:absolute;top:8px;right:8px;background:#dc3545;color:white;border:none;border-radius:50%;width:24px;height:24px;font-size:14px;cursor:pointer;opacity:0.7;z-index:10;">&times;</button>
                        <div style="height:100px;background:#272d3f;display:flex;align-items:center;justify-content:center;">
                            <span style="font-size:36px;opacity:0.4;">&#x1f4e8;</span>
                        </div>
                        <div style="padding:16px;">
                            <span style="display:inline-block;background:#272d3f;color:white;padding:4px 12px;border-radius:4px;font-size:12px;font-weight:600;text-transform:uppercase;margin-bottom:8px;">${monthCap} ${n.year}</span>
                            <p style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px;">${escapeHtml(savedBy)} &middot; ${savedAt} CT</p>
                            <button onclick="event.stopPropagation();viewPublishedNewsletter('${n.filename}')" style="width:100%;margin-top:12px;padding:12px 16px;background:#008181;color:white;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;">View Newsletter</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } else {
                document.getElementById('publishedEmpty').style.display = 'block';
                document.getElementById('publishedGrid').innerHTML = '';
            }
        } catch (e) { console.error('[Published] Load failed:', e); }
    }

    async function viewPublishedNewsletter(filename) {
        try {
            const resp = await fetch(`${API_BASE}/api/load-published?file=${encodeURIComponent(filename)}`);
            const data = await resp.json();
            if (!data.success || !data.draft) { alert('Could not load newsletter'); return; }
            const d = data.draft;
            // Try to render the email
            const content = buildPublishedContent(d);
            const renderResp = await fetch(`${API_BASE}/api/render-email-template`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, month: d.month || '', year: d.year || new Date().getFullYear(), images: d.generatedImages || {} })
            });
            const renderData = await renderResp.json();
            if (renderData.success && renderData.html) {
                document.getElementById('publishedModalContent').innerHTML = renderData.html;
            } else {
                document.getElementById('publishedModalContent').innerHTML = '<p style="padding:40px;text-align:center;">Could not render preview.</p>';
            }
            document.getElementById('publishedModal').style.display = 'block';
        } catch (e) {
            alert('Error: ' + e.message);
        }
    }

    function buildPublishedContent(d) {
        const gc = d.generatedContent || {};
        const sc = d.selectedContent || {};
        return {
            intro: gc.intro || d.introText || '',
            agenda_items: gc.agenda_items || [],
            news_of_month: gc.news_of_month || { title: sc.news_of_month?.title || '', description: '', thumbnail_url: sc.news_of_month?.thumbnail_url || '', video_url: sc.news_of_month?.url || '' },
            trend_alert: gc.trend_alert || { title: sc.trend_alert?.title || '', description: '', thumbnail_url: sc.trend_alert?.thumbnail_url || '', video_url: sc.trend_alert?.url || '' },
            blog_articles: gc.blog_articles || [
                { title: sc.blog_1?.title || '', image_url: sc.blog_1?.featured_image_url || '', url: sc.blog_1?.url || '' },
                { title: sc.blog_2?.title || '', image_url: sc.blog_2?.featured_image_url || '', url: sc.blog_2?.url || '' }
            ],
            guess_the_price: gc.guess_the_price || sc.guess_the_price || {},
            quick_tip: gc.quick_tip || d.quickTipText || ''
        };
    }

    function closePublishedModal() {
        document.getElementById('publishedModal').style.display = 'none';
    }

    // ============================================================
    // LINK TOOLBAR (matching jeweler)
    // ============================================================
    let savedSelection = null;
    let linkTargetEditorId = null;

    function saveSelection() {
        const sel = window.getSelection();
        if (sel.rangeCount > 0) savedSelection = sel.getRangeAt(0).cloneRange();
    }

    function restoreSelection() {
        if (!savedSelection) return;
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(savedSelection);
    }

    function showLinkPopover(editorId) {
        const editor = document.getElementById(editorId);
        if (editor) editor.focus();
        saveSelection();
        linkTargetEditorId = editorId;
        document.querySelectorAll('.link-popover').forEach(p => p.classList.remove('show'));
        const popover = document.getElementById('lp-' + editorId);
        if (popover) {
            popover.classList.add('show');
            const sel = window.getSelection();
            const selectedText = sel.toString().trim();
            const textInput = popover.querySelector('.lp-text');
            const urlInput = popover.querySelector('.lp-url');
            if (textInput) textInput.value = selectedText || '';
            if (urlInput) { urlInput.value = ''; urlInput.focus(); }
        }
    }

    function hideLinkPopover(editorId) {
        const popover = document.getElementById('lp-' + editorId);
        if (popover) popover.classList.remove('show');
        linkTargetEditorId = null;
    }

    function insertLink(editorId) {
        const popover = document.getElementById('lp-' + editorId);
        if (!popover) return;
        const text = popover.querySelector('.lp-text').value.trim();
        const url = popover.querySelector('.lp-url').value.trim();
        if (!url) return;
        const displayText = text || url;
        const linkHtml = `<a href="${url}" style="color:#008181;text-decoration:underline;" target="_blank">${displayText}</a>`;
        const editor = document.getElementById(editorId);
        if (editor) {
            editor.focus();
            restoreSelection();
            document.execCommand('insertHTML', false, linkHtml);
        }
        hideLinkPopover(editorId);
    }

    // Track cursor in editable divs
    document.addEventListener('selectionchange', function() {
        const sel = window.getSelection();
        if (sel.rangeCount > 0) {
            const node = sel.anchorNode;
            if (node) {
                const editable = node.nodeType === 1 ? node.closest('.editable') : (node.parentElement ? node.parentElement.closest('.editable') : null);
                if (editable) savedSelection = sel.getRangeAt(0).cloneRange();
            }
        }
    });

    // ============================================================
    // AUTO-GENERATE INTRO & QUICK TIP ON STEP 5 ENTRY
    // ============================================================
    async function autoGenerateIntroAndTip() {
        if (introAndTipGenerated) return;
        introAndTipGenerated = true;

        const introEl = document.getElementById('introContent');
        const tipEl = document.getElementById('quickTipContent');

        // Only auto-generate if fields are empty
        const introEmpty = !introEl?.value?.trim();
        const tipEmpty = !tipEl?.value?.trim();

        if (!introEmpty && !tipEmpty) return;

        // Show loading indicators
        if (introEmpty && introEl) introEl.placeholder = 'AI is generating your intro...';
        if (tipEmpty && tipEl) tipEl.placeholder = 'AI is generating a quick tip...';

        // Generate both in parallel
        const promises = [];

        if (introEmpty) {
            promises.push(
                fetch(`${API_BASE}/api/generate-newsletter`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        month: selectedMonth, intro: '',
                        news_of_month: { title: selectedContent.news_of_month?.title || '', description: '' },
                        trend_alert: { title: selectedContent.trend_alert?.title || '', description: '' },
                        blog_articles: [
                            { title: selectedContent.blog_1?.title || '' },
                            { title: selectedContent.blog_2?.title || '' }
                        ],
                        guess_the_price: { title: selectedContent.guess_the_price?.title || '' },
                        quick_tip: ''
                    })
                }).then(r => r.json()).then(data => {
                    if (data.success && data.generated?.intro && introEl) {
                        introEl.value = stripMarkdown(data.generated.intro);
                        updateWordCount('introContent', 'introWordCount');
                    }
                }).catch(e => console.error('Auto-gen intro error:', e))
            );
        }

        if (tipEmpty) {
            promises.push(
                fetch(`${API_BASE}/api/generate-quick-tip`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ month: selectedMonth || 'january' })
                }).then(r => r.json()).then(data => {
                    if (data.success && data.tip && tipEl) {
                        tipEl.value = stripMarkdown(data.tip);
                        updateWordCount('quickTipContent', 'quickTipWordCount');
                        if (data.image_prompt) {
                            const promptEl = document.getElementById('quickTipImagePrompt');
                            if (promptEl) promptEl.value = data.image_prompt;
                        }
                    }
                }).catch(e => console.error('Auto-gen tip error:', e))
            );
        }

        await Promise.all(promises);
        // Restore placeholders
        if (introEl) introEl.placeholder = 'Write a fun, engaging opening for this month\'s newsletter...';
        if (tipEl) tipEl.placeholder = 'A quick seasonal jewelry care tip for readers...';
    }

    // ============================================================
    // AI GENERATE INTRO (manual button)
    // ============================================================
    async function aiGenerateIntro() {
        const btn = event.target;
        btn.disabled = true; btn.textContent = 'Generating...';
        try {
            const highlights = [];
            if (selectedContent.news_of_month?.title) highlights.push('Video: ' + selectedContent.news_of_month.title);
            if (selectedContent.trend_alert?.title) highlights.push('Trend: ' + selectedContent.trend_alert.title);
            if (selectedContent.guess_the_price?.title) highlights.push('GTP: ' + selectedContent.guess_the_price.title);

            const resp = await fetch(`${API_BASE}/api/generate-newsletter`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    month: selectedMonth, intro: '',
                    news_of_month: { title: selectedContent.news_of_month?.title || '', description: '' },
                    trend_alert: { title: selectedContent.trend_alert?.title || '', description: '' },
                    blog_articles: [], guess_the_price: { title: selectedContent.guess_the_price?.title || '' },
                    quick_tip: document.getElementById('quickTipContent')?.value || ''
                })
            });
            const data = await resp.json();
            if (data.success && data.generated?.intro) {
                document.getElementById('introContent').value = stripMarkdown(data.generated.intro);
            } else { alert('Generation failed: ' + (data.error || '')); }
        } catch (e) { alert('Error: ' + e.message); }
        btn.disabled = false; btn.textContent = 'AI Generate';
        updateWordCount('introContent', 'introWordCount');
    }

    // ============================================================
    // BLOG URL FETCH
    // ============================================================
    async function loadBlogByUrl() {
        const url = document.getElementById('blogUrlInput').value.trim();
        if (!url) { alert('Please enter a blog URL'); return; }
        try {
            const resp = await fetch(`${API_BASE}/api/fetch-article-metadata`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            const data = await resp.json();
            if (data.success) {
                const m = data.metadata || data;
                const post = {
                    title: m.title || url,
                    url: url,
                    featured_image_url: m.image || '',
                    excerpt: m.description || '',
                    categories: [],
                    published_date: ''
                };
                toggleBlogSelect(post);
                document.getElementById('blogUrlInput').value = '';
            } else {
                alert('Could not fetch article: ' + (data.error || ''));
            }
        } catch (e) { alert('Error: ' + e.message); }
    }

    // ============================================================
    // AUTO IMAGE PROMPT GENERATION
    // ============================================================
    async function autoGenerateImagePrompts() {
        const btn = document.getElementById('autoPromptBtn');
        if (btn) { btn.disabled = true; btn.textContent = 'Generating prompts...'; }
        const loadingEl = document.getElementById('promptGenerationLoading');
        if (loadingEl) loadingEl.style.display = 'block';
        try {
            const sections = {};
            const gc = generatedContent;
            // Use generated content or fall back to selected content / user input
            const tipText = gc.quick_tip || document.getElementById('quickTipContent')?.value || '';
            const gtpTitle = gc.guess_the_price?.title || selectedContent.guess_the_price?.title || 'Guess the Price';
            const gtpQuestion = gc.guess_the_price?.question || '';
            if (tipText) sections.quick_tip = { title: 'Quick Tip', content: tipText };
            sections.guess_the_price = { title: gtpTitle, content: gtpQuestion || selectedContent.guess_the_price?.fun_fact || '' };

            const resp = await fetch(`${API_BASE}/api/generate-image-prompts`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sections })
            });
            const data = await resp.json();
            if (data.success && data.prompts) {
                if (data.prompts.quick_tip?.prompt) {
                    document.getElementById('quickTipImagePrompt').value = data.prompts.quick_tip.prompt;
                }
                if (data.prompts.guess_the_price?.prompt) {
                    document.getElementById('gtpImagePrompt').value = data.prompts.guess_the_price.prompt;
                }
                generatedPrompts = data.prompts;
                promptsAlreadyGenerated = true;
            }
        } catch (e) { console.error('Image prompt gen error:', e); }
        if (loadingEl) loadingEl.style.display = 'none';
        if (btn) { btn.disabled = false; btn.textContent = 'Regenerate Image Prompts'; }
    }

    // ============================================================
    // AUTO SUBJECT LINE GENERATION
    // ============================================================
    let subjectLinesGenerated = false;
    async function autoGenerateSubjectLinesIfNeeded() {
        if (subjectLinesGenerated) return;
        subjectLinesGenerated = true;
        generateSubjectLinesWithTone();
    }

    // ============================================================
    // PREVIEW EDITING (matching jeweler)
    // ============================================================
    let savedEditedHTML = null;

    function enableNewsletterEditing() {
        const preview = document.getElementById('newsletterPreview');
        if (!preview) return;
        const textElements = preview.querySelectorAll('p, div[style*="font-size"], h2, h3, h4, h5');
        textElements.forEach(el => {
            if (el.children.length > 0 && el.textContent.trim().length < 50) return;
            el.setAttribute('contenteditable', 'true');
            el.style.cursor = 'text';
            el.style.transition = 'background-color 0.2s';
            el.addEventListener('focus', () => {
                el.style.backgroundColor = '#fef3c7';
                el.style.outline = '2px solid #f59e0b';
            });
            el.addEventListener('blur', () => {
                el.style.backgroundColor = '';
                el.style.outline = '';
                updateNewsletterHTML();
            });
        });
    }

    function updateNewsletterHTML() {
        const preview = document.getElementById('newsletterPreview');
        if (!preview) return;
        savedEditedHTML = preview.innerHTML;
        renderedEmailHTML = savedEditedHTML;
        const htmlCode = document.getElementById('htmlCode');
        if (htmlCode) htmlCode.textContent = savedEditedHTML;
    }

    function savePreviewEdits() {
        updateNewsletterHTML();
        const status = document.getElementById('saveStatus');
        if (status) {
            status.style.display = 'inline';
            setTimeout(() => { status.style.display = 'none'; }, 2000);
        }
    }

    // ============================================================
    // BRITEPULSE USER IDENTIFICATION
    // ============================================================
    function setBritePulseUser(user) {
        function trySetUser() {
            const instance = window.BritePulse?.getInstance();
            if (instance) {
                instance.setUser({
                    id: user.id || user.email,
                    email: user.email,
                    name: user.name || user.email
                });
                console.log('BritePulse user set:', user.email);
            } else {
                // SDK not ready yet, retry
                setTimeout(trySetUser, 100);
            }
        }
        trySetUser();
    }

    function clearBritePulseUser() {
        window.BritePulse?.getInstance()?.setUser(undefined);
    }

    // Set user FIRST - before any other code that might fail
    if (window.AUTH_USER) {
        setBritePulseUser(window.AUTH_USER);
    }

    // ============================================================
    // USER PROFILE DROPDOWN
    // ============================================================
    function initUserProfile() {
        const user = window.AUTH_USER || {};
        const avatar = document.getElementById('userAvatar');
        const nameEl = document.getElementById('userDropdownName');
        const emailEl = document.getElementById('userDropdownEmail');

        if (avatar && user.picture) {
            avatar.src = user.picture;
        } else if (avatar) {
            // Default avatar if no picture
            avatar.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><circle cx="20" cy="20" r="20" fill="%23018181"/><text x="20" y="26" text-anchor="middle" fill="white" font-size="18" font-family="sans-serif">' + (user.name ? user.name.charAt(0).toUpperCase() : 'U') + '</text></svg>';
        }
        if (nameEl) nameEl.textContent = user.name || 'User';
        if (emailEl) emailEl.textContent = user.email || '';
    }

    function toggleUserDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('active');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('userDropdown');
        const avatar = document.getElementById('userAvatar');
        if (dropdown && !dropdown.contains(event.target) && event.target !== avatar) {
            dropdown.classList.remove('active');
        }
    });

    // ============================================================
    // INIT
    // ============================================================
    document.addEventListener('DOMContentLoaded', function() {
        initUserProfile();
        initMonthGrid();
        setupWordCounters();
        loadDrafts();
        loadPublishedNewsletters();
    });
    </script>
<!-- Crop Modal -->
<div id="cropModal" class="crop-modal" onclick="if(event.target===this)closeCropModal()">
    <div class="crop-container">
        <h3>Crop &amp; Reposition Image</h3>
        <div style="max-height:500px;overflow:hidden;">
            <img id="cropImage" class="crop-preview" style="max-width:100%;">
        </div>
        <div class="crop-actions">
            <button class="btn-secondary" onclick="closeCropModal()">Cancel</button>
            <button class="btn-primary" onclick="applyCrop()">Apply Crop</button>
        </div>
    </div>
</div>
</body>
</html>
